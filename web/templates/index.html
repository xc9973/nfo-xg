<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFO ç¼–è¾‘å™¨</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <div class="file-browser">
            <h3>ğŸ“ æ–‡ä»¶æµè§ˆ</h3>
            <div class="path-bar" id="currentPath">~</div>
            <div class="search-section">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="æœç´¢ NFO æ–‡ä»¶..." onkeypress="if(event.key==='Enter')search()">
                    <button class="btn btn-primary search-btn" onclick="search()">ğŸ”</button>
                    <button class="btn btn-secondary clear-btn" id="clearSearchBtn" onclick="clearSearch()" style="display:none">âœ•</button>
                </div>
                <div class="search-loading" id="searchLoading" style="display:none">
                    <span class="spinner"></span> æœç´¢ä¸­...
                </div>
            </div>
            <div class="search-results" id="searchResults" style="display:none"></div>
            <div class="file-list" id="fileList"></div>
            <div class="template-section">
                <h4>ğŸ“‹ æ¨¡æ¿</h4>
                <div id="templateList"></div>
                <button class="btn btn-secondary" onclick="showTemplateModal()" style="width:100%;margin-top:5px">+ æ–°å»ºæ¨¡æ¿</button>
            </div>
        </div>
        
        <div class="editor">
            <h2>
                NFO ç¼–è¾‘å™¨
                <span id="modifiedBadge" class="modified-badge" style="display:none">â— æœªä¿å­˜</span>
                <button class="btn-icon-small" onclick="toggleHistory()" title="æ“ä½œå†å²" id="historyBtn" style="display:none">ğŸ“œ</button>
            </h2>

            <!-- å†å²é¢æ¿ -->
            <div id="historyPanel" class="history-panel" style="display:none">
                <div class="history-header">
                    <h4>æ“ä½œå†å²</h4>
                    <button class="btn-icon-small" onclick="toggleHistory()">Ã—</button>
                </div>
                <div id="historyList" class="history-list"></div>
            </div>

            <div id="editorContent">
                <p style="color:#666">â† ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ª .nfo æ–‡ä»¶å¼€å§‹ç¼–è¾‘</p>
            </div>

            <!-- æ·»åŠ åŠ è½½çŠ¶æ€è¦†ç›–å±‚ -->
            <div id="editorLoading" class="editor-loading" style="display:none">
                <div class="loading-spinner">
                    <span class="spinner large"></span>
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentFile = null;
        let nfoData = null;

        // ä¿®æ”¹çŠ¶æ€ç®¡ç†
        let isModified = false;

        function setModified(value) {
            isModified = value;
            const badge = document.getElementById('modifiedBadge');
            if (badge) {
                badge.style.display = value ? 'inline-block' : 'none';
            }
        }

        function checkModified() {
            if (isModified) {
                return confirm('æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ');
            }
            return true;
        }

        // æ“ä½œå†å²è®°å½•
        let actionHistory = [];

        function addHistory(action, type) {
            const timestamp = new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            actionHistory.unshift({action, type, timestamp});

            // æœ€å¤šä¿ç•™ 20 æ¡
            if (actionHistory.length > 20) {
                actionHistory = actionHistory.slice(0, 20);
            }

            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            const btn = document.getElementById('historyBtn');

            if (actionHistory.length === 0) {
                btn.style.display = 'none';
                return;
            }

            btn.style.display = 'inline-block';

            list.innerHTML = actionHistory.map(item => `
                <div class="history-item ${item.type}">
                    <span>${item.action}</span>
                    <span class="history-time">${item.timestamp}</span>
                </div>
            `).join('');
        }

        function toggleHistory() {
            const panel = document.getElementById('historyPanel');
            panel.style.display = panel.style.display === 'none' ? 'flex' : 'none';
        }

        // Load directory
        async function loadDir(path = '') {
            if (!checkModified()) return;

            try {
                const res = await fetch('/api/list', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({path})
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail);
                
                document.getElementById('currentPath').textContent = data.current;
                renderFileList(data);
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        function renderFileList(data) {
            const list = document.getElementById('fileList');
            let html = '';
            
            if (data.parent) {
                html += `<div class="file-item dir" onclick="loadDir('${data.parent}')">ğŸ“ ..</div>`;
            }
            
            for (const item of data.items) {
                if (item.is_dir) {
                    html += `<div class="file-item dir" onclick="loadDir('${item.path}')">ğŸ“ ${item.name}</div>`;
                } else if (item.is_nfo) {
                    html += `<div class="file-item nfo" onclick="loadNfo('${item.path}')">ğŸ“„ ${item.name}</div>`;
                }
            }
            
            list.innerHTML = html;
        }

        // Load NFO file
        async function loadNfo(path) {
            // æ£€æŸ¥æœªä¿å­˜æ›´æ”¹
            if (!checkModified()) return;

            const loading = document.getElementById('editorLoading');

            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                loading.style.display = 'flex';

                const res = await fetch('/api/load', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({path})
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail);

                currentFile = path;
                nfoData = data.data;
                renderEditor();
                setModified(false); // åŠ è½½æ–°æ–‡ä»¶åæ¸…é™¤ä¿®æ”¹æ ‡è®°
                showToast('åŠ è½½æˆåŠŸ', 'success');

                // è®°å½•å†å²
                addHistory(`åŠ è½½: ${path.split('/').pop()}`, 'load');

            } catch (e) {
                showToast(e.message, 'error');
            } finally {
                loading.style.display = 'none';
            }
        }

        function renderEditor() {
            const d = nfoData;
            document.getElementById('editorContent').innerHTML = `
                <div class="form-grid">
                    <div class="form-group">
                        <label>ç±»å‹</label>
                        <select id="nfo_type">
                            <option value="movie" ${d.nfo_type==='movie'?'selected':''}>ç”µå½±</option>
                            <option value="tvshow" ${d.nfo_type==='tvshow'?'selected':''}>å‰§é›†</option>
                            <option value="episodedetails" ${d.nfo_type==='episodedetails'?'selected':''}>å•é›†</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æ ‡é¢˜</label>
                        <div class="input-with-action">
                            <input type="text" id="title" value="${esc(d.title)}">
                            <button class="btn btn-primary btn-icon" onclick="openTMDBSearch()" title="ä» TMDB æœç´¢">ğŸ”</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>åŸæ ‡é¢˜</label>
                        <input type="text" id="originaltitle" value="${esc(d.originaltitle)}">
                    </div>
                    <div class="form-group">
                        <label>å¹´ä»½</label>
                        <input type="text" id="year" value="${esc(d.year)}" placeholder="1900-2100">
                    </div>
                    <div class="form-group">
                        <label>æ—¶é•¿(åˆ†é’Ÿ)</label>
                        <input type="text" id="runtime" value="${esc(d.runtime)}">
                    </div>
                    <div class="form-group">
                        <label>è¯„åˆ†</label>
                        <input type="text" id="rating" value="${esc(d.rating)}" placeholder="0-10">
                    </div>
                    <div class="form-group">
                        <label>åˆ¶ç‰‡å‚</label>
                        <input type="text" id="studio" value="${esc(d.studio)}">
                    </div>
                    <div class="form-group">
                        <label>å­£</label>
                        <input type="text" id="season" value="${esc(d.season)}">
                    </div>
                    <div class="form-group">
                        <label>é›†</label>
                        <input type="text" id="episode" value="${esc(d.episode)}">
                    </div>
                    <div class="form-group">
                        <label>æ’­å‡ºæ—¥æœŸ</label>
                        <input type="text" id="aired" value="${esc(d.aired)}" placeholder="YYYY-MM-DD">
                    </div>
                    <div class="form-group full-width">
                        <label>ç®€ä»‹</label>
                        <textarea id="plot">${esc(d.plot)}</textarea>
                    </div>
                    <div class="form-group">
                        <label>æµ·æŠ¥è·¯å¾„</label>
                        <input type="text" id="poster" value="${esc(d.poster)}" placeholder="poster.jpg">
                    </div>
                    <div class="form-group">
                        <label>èƒŒæ™¯å›¾è·¯å¾„</label>
                        <input type="text" id="fanart" value="${esc(d.fanart)}" placeholder="fanart.jpg">
                    </div>
                    <div class="form-group full-width">
                        <label>ç±»å‹</label>
                        <div class="list-editor" id="genresEditor"></div>
                    </div>
                    <div class="form-group full-width">
                        <label>å¯¼æ¼”</label>
                        <div class="list-editor" id="directorsEditor"></div>
                    </div>
                    <div class="form-group full-width">
                        <label>æ¼”å‘˜</label>
                        <div class="list-editor" id="actorsEditor"></div>
                    </div>
                </div>
                <div class="actions">
                    <button class="btn btn-primary" id="saveBtn" onclick="saveNfo()">
                        <span class="btn-text">ğŸ’¾ ä¿å­˜</span>
                        <span class="btn-loading" style="display:none"><span class="spinner"></span> ä¿å­˜ä¸­...</span>
                        <span class="btn-success" style="display:none">âœ“ å·²ä¿å­˜</span>
                    </button>
                    <button class="btn btn-secondary" onclick="loadNfo(currentFile)">ğŸ”„ é‡æ–°åŠ è½½</button>
                    <button class="btn btn-secondary" onclick="saveAsTemplate()">ğŸ“‹ å­˜ä¸ºæ¨¡æ¿</button>
                </div>
            `;
            renderListEditor('genresEditor', d.genres, 'genres');
            renderListEditor('directorsEditor', d.directors, 'directors');
            renderActorsEditor();

            // ä¸ºæ‰€æœ‰è¾“å…¥æ¡†æ·»åŠ ä¿®æ”¹è¿½è¸ª
            document.querySelectorAll('#editorContent input, #editorContent textarea, #editorContent select').forEach(el => {
                el.addEventListener('input', () => setModified(true));
                el.addEventListener('change', () => setModified(true));
            });
        }

        function esc(s) {
            return (s || '').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function renderListEditor(containerId, items, field) {
            const container = document.getElementById(containerId);
            let html = '<div class="list-items">';
            items.forEach((item, i) => {
                html += `<span class="list-item">${esc(item)} <span class="remove" onclick="removeItem('${field}', ${i})">Ã—</span></span>`;
            });
            html += '</div>';
            html += `<div class="list-input">
                <input type="text" id="${field}Input" placeholder="æ·»åŠ ..." onkeypress="if(event.key==='Enter')addItem('${field}')">
                <button class="btn btn-secondary" onclick="addItem('${field}')">+</button>
            </div>`;
            container.innerHTML = html;
        }

        function addItem(field) {
            const input = document.getElementById(field + 'Input');
            const val = input.value.trim();
            if (val) {
                nfoData[field].push(val);
                input.value = '';
                renderListEditor(field + 'Editor', nfoData[field], field);
            }
        }

        function removeItem(field, index) {
            nfoData[field].splice(index, 1);
            renderListEditor(field + 'Editor', nfoData[field], field);
        }

        function renderActorsEditor() {
            const container = document.getElementById('actorsEditor');
            let html = '<div class="actors-list">';
            nfoData.actors.forEach((actor, i) => {
                html += `<div class="actor-item">
                    <input type="text" value="${esc(actor.name)}" placeholder="å§“å" onchange="updateActor(${i}, 'name', this.value)">
                    <input type="text" value="${esc(actor.role)}" placeholder="è§’è‰²" onchange="updateActor(${i}, 'role', this.value)">
                    <button class="btn btn-secondary" onclick="removeActor(${i})">Ã—</button>
                </div>`;
            });
            html += '</div>';
            html += `<div class="list-input" style="margin-top:10px">
                <input type="text" id="actorNameInput" placeholder="æ¼”å‘˜å§“å" style="flex:1">
                <input type="text" id="actorRoleInput" placeholder="è§’è‰²" style="flex:1">
                <button class="btn btn-secondary" onclick="addActor()">+</button>
            </div>`;
            container.innerHTML = html;
        }

        function addActor() {
            const name = document.getElementById('actorNameInput').value.trim();
            const role = document.getElementById('actorRoleInput').value.trim();
            if (name) {
                nfoData.actors.push({name, role, thumb: '', order: nfoData.actors.length});
                document.getElementById('actorNameInput').value = '';
                document.getElementById('actorRoleInput').value = '';
                renderActorsEditor();
            }
        }

        function updateActor(index, field, value) {
            nfoData.actors[index][field] = value;
        }

        function removeActor(index) {
            nfoData.actors.splice(index, 1);
            renderActorsEditor();
        }

        function collectData() {
            return {
                nfo_type: document.getElementById('nfo_type').value,
                title: document.getElementById('title').value,
                originaltitle: document.getElementById('originaltitle').value,
                year: document.getElementById('year').value,
                plot: document.getElementById('plot').value,
                runtime: document.getElementById('runtime').value,
                genres: nfoData.genres,
                directors: nfoData.directors,
                actors: nfoData.actors,
                studio: document.getElementById('studio').value,
                rating: document.getElementById('rating').value,
                poster: document.getElementById('poster').value,
                fanart: document.getElementById('fanart').value,
                season: document.getElementById('season').value,
                episode: document.getElementById('episode').value,
                aired: document.getElementById('aired').value,
            };
        }

        async function saveNfo() {
            const saveBtn = document.getElementById('saveBtn');

            try {
                // è®¾ç½®åŠ è½½çŠ¶æ€
                saveBtn.classList.add('loading');

                const data = collectData();
                const res = await fetch('/api/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({path: currentFile, data})
                });
                const result = await res.json();

                if (!res.ok) throw new Error(result.detail);

                // è®¾ç½®æˆåŠŸçŠ¶æ€
                saveBtn.classList.remove('loading');
                saveBtn.classList.add('success');
                showToast('ä¿å­˜æˆåŠŸ!', 'success');

                // æ¸…é™¤ä¿®æ”¹æ ‡è®°
                if (typeof setModified === 'function') {
                    setModified(false);
                }

                // è®°å½•å†å²
                addHistory(`ä¿å­˜: ${currentFile.split('/').pop()}`, 'save');

                // 2ç§’åæ¢å¤æŒ‰é’®çŠ¶æ€
                setTimeout(() => {
                    saveBtn.classList.remove('success');
                }, 2000);

            } catch (e) {
                saveBtn.classList.remove('loading');
                showToast(e.message, 'error');
            }
        }

        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toastContainer');

            // åˆ›å»º Toast å…ƒç´ 
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            // æ·»åŠ å›¾æ ‡
            const icons = {
                success: 'âœ“',
                error: 'âœ•',
                warning: 'âš ',
                info: 'â„¹'
            };

            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <span class="toast-message">${esc(message)}</span>
            `;

            container.appendChild(toast);

            // è‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                toast.classList.add('removing');
                toast.addEventListener('animationend', () => {
                    toast.remove();
                });
            }, duration);

            // å…è®¸ç‚¹å‡»å…³é—­
            toast.addEventListener('click', () => {
                toast.classList.add('removing');
                toast.addEventListener('animationend', () => {
                    toast.remove();
                });
            });
        }

        // Init
        loadDir('');
        loadTemplates();

        // é”®ç›˜äº‹ä»¶
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeTMDBModal();
            }
        });

        // ========== TMDB æœç´¢åŠŸèƒ½ ==========
        let searchDebounceTimer = null;
        const SEARCH_DEBOUNCE_MS = 300;

        // æ‰“å¼€ TMDB æœç´¢æ¨¡æ€æ¡†ï¼Œé¢„å¡«å½“å‰æ ‡é¢˜å¹¶è‡ªåŠ¨æœç´¢
        function openTMDBSearch() {
            const modal = document.getElementById('tmdbModal');
            const searchInput = document.getElementById('tmdbSearchInput');

            // é¢„å¡«å½“å‰æ ‡é¢˜ä½œä¸ºæœç´¢è¯
            const currentTitle = document.getElementById('title')?.value || '';
            searchInput.value = currentTitle;

            // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
            document.getElementById('tmdbResults').innerHTML = '';
            document.getElementById('tmdbError').style.display = 'none';

            modal.classList.add('active');

            // å¦‚æœæœ‰é¢„å¡«å†…å®¹ï¼Œè‡ªåŠ¨æœç´¢
            if (currentTitle) {
                // å…ˆè®¾ç½®åŠ è½½çŠ¶æ€ï¼Œé¿å…ç©ºç™½é—ªçƒ
                document.getElementById('tmdbLoading').style.display = 'flex';
                searchTMDB();
            } else {
                searchInput.focus();
            }
        }

        // å…³é—­ TMDB æœç´¢æ¨¡æ€æ¡†
        function closeTMDBModal() {
            document.getElementById('tmdbModal').classList.remove('active');
        }

        // å¤„ç†æ¨¡æ€æ¡†ç‚¹å‡»äº‹ä»¶ï¼ˆèƒŒæ™¯ç‚¹å‡»å…³é—­ï¼‰
        function handleModalClick(event) {
            if (event.target.id === 'tmdbModal') {
                closeTMDBModal();
            }
        }

        // æ‰§è¡Œ TMDB æœç´¢è¯·æ±‚
        async function searchTMDB() {
            // æ¸…é™¤ä¹‹å‰çš„é˜²æŠ–è®¡æ—¶å™¨
            if (searchDebounceTimer) {
                clearTimeout(searchDebounceTimer);
            }

            const query = document.getElementById('tmdbSearchInput').value.trim();

            if (!query) {
                showToast('è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'error');
                return;
            }

            // éªŒè¯æŸ¥è¯¢é•¿åº¦
            if (query.length > 200) {
                showToast('æœç´¢å…³é”®è¯è¿‡é•¿ï¼ˆæœ€å¤š200å­—ç¬¦ï¼‰', 'error');
                return;
            }

            const loading = document.getElementById('tmdbLoading');
            const errorDiv = document.getElementById('tmdbError');
            const resultsDiv = document.getElementById('tmdbResults');

            // UI çŠ¶æ€
            loading.style.display = 'flex';
            errorDiv.style.display = 'none';
            resultsDiv.innerHTML = '';

            // é˜²æŠ–ï¼š300ms åæ‰§è¡Œæœç´¢
            searchDebounceTimer = setTimeout(async () => {
                try {
                    const res = await fetch(`/api/tmdb/search?q=${encodeURIComponent(query)}`);
                    const data = await res.json();

                    if (!res.ok) {
                        // æ˜ å°„é”™è¯¯æ¶ˆæ¯
                        let errorMsg = 'æœç´¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                        if (res.status === 401) {
                            errorMsg = 'TMDB API Key æœªé…ç½®æˆ–æ— æ•ˆï¼Œè¯·è”ç³»ç®¡ç†å‘˜';
                        } else if (res.status === 429) {
                            errorMsg = 'æœç´¢è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•';
                        } else if (data.detail) {
                            errorMsg = data.detail;
                        }
                        throw new Error(errorMsg);
                    }

                    renderTMDBResults(data.results);
                } catch (e) {
                    errorDiv.textContent = e.message;
                    errorDiv.style.display = 'block';
                } finally {
                    loading.style.display = 'none';
                }
            }, SEARCH_DEBOUNCE_MS);
        }

        // æ¸²æŸ“ TMDB æœç´¢ç»“æœå¡ç‰‡
        function renderTMDBResults(results) {
            const container = document.getElementById('tmdbResults');

            if (results.length === 0) {
                container.innerHTML = '<div class="tmdb-no-results">æœªæ‰¾åˆ°åŒ¹é…ç»“æœ</div>';
                return;
            }

            // è¿‡æ»¤åªæ˜¾ç¤ºç”µå½±å’Œç”µè§†å‰§
            const filteredResults = results.filter(item =>
                item.media_type === 'movie' || item.media_type === 'tv'
            );

            if (filteredResults.length === 0) {
                container.innerHTML = '<div class="tmdb-no-results">æœªæ‰¾åˆ°åŒ¹é…çš„ç”µå½±æˆ–å‰§é›†</div>';
                return;
            }

            let html = '<div class="tmdb-results-grid">';
            for (const item of filteredResults) {
                const posterUrl = item.poster_url
                    ? item.poster_url
                    : 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="300" viewBox="0 0 200 300"><rect fill="%232a2a4a" width="200" height="300"/><text fill="%23666" x="50%" y="50%" text-anchor="middle" dy=".3em" font-size="24">ğŸ¬</text></svg>';
                const year = item.year || 'æœªçŸ¥';
                const typeLabel = item.media_type === 'movie' ? 'ç”µå½±' : 'å‰§é›†';

                html += `
                    <div class="tmdb-result-card" onclick="selectTMDBResult(${item.id}, '${item.media_type}')">
                        <div class="tmdb-poster">
                            <img src="${posterUrl}" alt="${esc(item.title)}" loading="lazy">
                        </div>
                        <div class="tmdb-info">
                            <span class="tmdb-type">${typeLabel}</span>
                            <div class="tmdb-title">${esc(item.title)}</div>
                            <div class="tmdb-year">${year}</div>
                        </div>
                    </div>
                `;
            }
            html += '</div>';
            container.innerHTML = html;
        }

        // é€‰æ‹© TMDB ç»“æœå¹¶è·å–è¯¦æƒ…
        async function selectTMDBResult(tmdbId, mediaType) {
            const loading = document.getElementById('tmdbLoading');
            const errorDiv = document.getElementById('tmdbError');

            loading.style.display = 'flex';
            errorDiv.style.display = 'none';

            try {
                let endpoint;
                if (mediaType === 'movie') {
                    endpoint = `/api/tmdb/movie/${tmdbId}`;
                } else {
                    endpoint = `/api/tmdb/tv/${tmdbId}`;
                }

                const res = await fetch(endpoint);
                const nfoDataResult = await res.json();

                if (!res.ok) {
                    // æ˜ å°„é”™è¯¯æ¶ˆæ¯
                    let errorMsg = 'è·å–è¯¦æƒ…å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                    if (res.status === 401) {
                        errorMsg = 'TMDB API Key æœªé…ç½®æˆ–æ— æ•ˆï¼Œè¯·è”ç³»ç®¡ç†å‘˜';
                    } else if (res.status === 404) {
                        errorMsg = 'æœªæ‰¾åˆ°è¯¥å†…å®¹çš„è¯¦ç»†ä¿¡æ¯';
                    } else if (res.status === 429) {
                        errorMsg = 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•';
                    } else if (nfoDataResult.detail) {
                        errorMsg = nfoDataResult.detail;
                    }
                    throw new Error(errorMsg);
                }

                // å¡«å……è¡¨å•
                applyTMDBData(nfoDataResult);

                // å…³é—­æ¨¡æ€æ¡†ï¼ˆä»…åœ¨æˆåŠŸæ—¶ï¼‰
                closeTMDBModal();
                showToast('å·²ä» TMDB è·å–æ•°æ®', 'success');
            } catch (e) {
                errorDiv.textContent = e.message;
                errorDiv.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        // å°† TMDB æ•°æ®åº”ç”¨åˆ° NFO è¡¨å•
        function applyTMDBData(data) {
            if (!nfoData) {
                showToast('è¯·å…ˆåŠ è½½æˆ–åˆ›å»º NFO æ–‡ä»¶', 'error');
                return;
            }

            // æ›´æ–° nfoData å¯¹è±¡
            nfoData.nfo_type = data.nfo_type || nfoData.nfo_type;
            nfoData.title = data.title || '';
            nfoData.originaltitle = data.originaltitle || '';
            nfoData.year = data.year || '';
            nfoData.plot = data.plot || '';
            nfoData.runtime = data.runtime || '';
            nfoData.rating = data.rating || '';
            nfoData.genres = data.genres || [];
            nfoData.directors = data.directors || [];
            nfoData.actors = data.actors || [];
            nfoData.studio = data.studio || '';
            nfoData.poster = data.poster || '';
            nfoData.fanart = data.fanart || '';
            nfoData.season = data.season || '';
            nfoData.episode = data.episode || '';
            nfoData.aired = data.aired || '';

            // é‡æ–°æ¸²æŸ“è¡¨å•
            renderEditor();

            // è®°å½•å†å²
            addHistory('ä» TMDB è·å–æ•°æ®', 'apply');
        }

        // ========== æœç´¢åŠŸèƒ½ ==========
        let searchResults = [];
        let selectedSearchResult = null;

        async function search() {
            const query = document.getElementById('searchInput').value.trim();
            
            // å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼Œæ¸…é™¤æœç´¢ç»“æœ
            if (!query) {
                clearSearch();
                return;
            }
            
            const currentPath = document.getElementById('currentPath').textContent;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('searchLoading').style.display = 'flex';
            document.getElementById('clearSearchBtn').style.display = 'none';
            
            try {
                const res = await fetch('/api/search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        query: query,
                        path: currentPath === '~' ? '' : currentPath,
                        max_depth: 5,
                        max_results: 50
                    })
                });
                const data = await res.json();
                
                if (!res.ok) {
                    throw new Error(data.detail || 'æœç´¢å¤±è´¥');
                }
                
                searchResults = data.results;
                renderSearchResults(data.results, data.truncated);
                
            } catch (e) {
                showToast(e.message, 'error');
            } finally {
                document.getElementById('searchLoading').style.display = 'none';
            }
        }

        function renderSearchResults(results, truncated) {
            const container = document.getElementById('searchResults');
            const fileList = document.getElementById('fileList');
            
            // æ˜¾ç¤ºæœç´¢ç»“æœåŒºåŸŸï¼Œéšè—æ–‡ä»¶åˆ—è¡¨
            container.style.display = 'block';
            fileList.style.display = 'none';
            document.getElementById('clearSearchBtn').style.display = 'inline-block';
            
            if (results.length === 0) {
                container.innerHTML = '<div class="search-no-results">æœªæ‰¾åˆ°åŒ¹é…çš„æ–‡ä»¶</div>';
                return;
            }
            
            let html = `
                <div class="search-results-header">
                    <span>æœç´¢ç»“æœ</span>
                    <span class="search-results-count">${results.length} ä¸ªæ–‡ä»¶</span>
                </div>
            `;
            
            if (truncated) {
                html += '<div class="search-truncated">âš ï¸ ç»“æœå¯èƒ½ä¸å®Œæ•´ï¼Œå·²è¾¾åˆ°æœ€å¤§æ•°é‡é™åˆ¶</div>';
            }
            
            for (const item of results) {
                const isSelected = selectedSearchResult === item.path ? 'selected' : '';
                const matchTypeLabel = getMatchTypeLabel(item.match_type);
                
                html += `
                    <div class="search-result-item ${isSelected}" onclick="selectSearchResult('${esc(item.path)}')">
                        <div class="search-result-filename">ğŸ“„ ${esc(item.filename)}</div>
                        <div class="search-result-path">${esc(item.path)}</div>
                        <span class="search-result-match">${matchTypeLabel}</span>
                        ${item.title ? `<div class="search-result-title">${esc(item.title)}</div>` : ''}
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function getMatchTypeLabel(matchType) {
            const labels = {
                'filename': 'æ–‡ä»¶å',
                'title': 'æ ‡é¢˜',
                'originaltitle': 'åŸæ ‡é¢˜',
                'actor': 'æ¼”å‘˜',
                'plot': 'ç®€ä»‹'
            };
            return labels[matchType] || matchType;
        }

        async function selectSearchResult(path) {
            selectedSearchResult = path;
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            const items = document.querySelectorAll('.search-result-item');
            items.forEach(item => {
                if (item.onclick.toString().includes(path)) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
            
            // åŠ è½½ NFO æ–‡ä»¶
            await loadNfo(path);
            
            // å¯¼èˆªåˆ°æ–‡ä»¶æ‰€åœ¨ç›®å½•
            const parentDir = path.substring(0, path.lastIndexOf('/')) || path.substring(0, path.lastIndexOf('\\'));
            if (parentDir) {
                document.getElementById('currentPath').textContent = parentDir;
            }
        }

        function clearSearch() {
            const container = document.getElementById('searchResults');
            const fileList = document.getElementById('fileList');
            
            // éšè—æœç´¢ç»“æœï¼Œæ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
            container.style.display = 'none';
            fileList.style.display = 'block';
            document.getElementById('clearSearchBtn').style.display = 'none';
            document.getElementById('searchInput').value = '';
            
            searchResults = [];
            selectedSearchResult = null;
            
            // é‡æ–°åŠ è½½å½“å‰ç›®å½•
            const currentPath = document.getElementById('currentPath').textContent;
            loadDir(currentPath === '~' ? '' : currentPath);
        }

        // ========== æ¨¡æ¿åŠŸèƒ½ ==========
        let templates = [];

        async function loadTemplates() {
            try {
                const res = await fetch('/api/templates');
                const data = await res.json();
                templates = data.templates || [];
                renderTemplates();
            } catch (e) {
                console.error('åŠ è½½æ¨¡æ¿å¤±è´¥', e);
            }
        }

        function renderTemplates() {
            const list = document.getElementById('templateList');
            if (templates.length === 0) {
                list.innerHTML = '<div style="color:#666;font-size:12px;padding:5px">æš‚æ— æ¨¡æ¿</div>';
                return;
            }
            list.innerHTML = templates.map(t => `
                <div class="template-item">
                    <span onclick="applyTemplate('${esc(t.name)}')">${esc(t.name)}</span>
                    <span class="remove" onclick="deleteTemplate('${esc(t.name)}')">Ã—</span>
                </div>
            `).join('');
        }

        function applyTemplate(name) {
            const t = templates.find(x => x.name === name);
            if (!t || !nfoData) return;
            
            nfoData.nfo_type = t.nfo_type || nfoData.nfo_type;
            nfoData.genres = [...(t.genres || [])];
            nfoData.directors = [...(t.directors || [])];
            nfoData.studio = t.studio || nfoData.studio;
            
            renderEditor();
            showToast('å·²åº”ç”¨æ¨¡æ¿: ' + name, 'success');
        }

        async function deleteTemplate(name) {
            if (!confirm('ç¡®å®šåˆ é™¤æ¨¡æ¿ "' + name + '"?')) return;
            try {
                const res = await fetch('/api/templates/' + encodeURIComponent(name), {method: 'DELETE'});
                if (!res.ok) throw new Error('åˆ é™¤å¤±è´¥');
                await loadTemplates();
                showToast('æ¨¡æ¿å·²åˆ é™¤', 'success');
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        async function saveAsTemplate() {
            const name = prompt('è¯·è¾“å…¥æ¨¡æ¿åç§°:');
            if (!name) return;
            
            const data = {
                name,
                nfo_type: document.getElementById('nfo_type').value,
                genres: nfoData.genres,
                directors: nfoData.directors,
                studio: document.getElementById('studio').value,
            };
            
            try {
                const res = await fetch('/api/templates', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                if (!res.ok) throw new Error('ä¿å­˜å¤±è´¥');
                await loadTemplates();
                showToast('æ¨¡æ¿å·²ä¿å­˜', 'success');
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        function showTemplateModal() {
            if (!nfoData) {
                showToast('è¯·å…ˆæ‰“å¼€ä¸€ä¸ª NFO æ–‡ä»¶', 'error');
                return;
            }
            saveAsTemplate();
        }
    </script>

    <!-- TMDB æœç´¢æ¨¡æ€æ¡† -->
    <div id="tmdbModal" class="modal" onclick="handleModalClick(event)">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ¬ æœç´¢ TMDB</h3>
                <button class="modal-close" onclick="closeTMDBModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="tmdb-search-bar">
                    <input type="text" id="tmdbSearchInput" placeholder="è¾“å…¥ç”µå½±æˆ–å‰§é›†åç§°..."
                        onkeypress="if(event.key==='Enter')searchTMDB()">
                    <button class="btn btn-primary" onclick="searchTMDB()">æœç´¢</button>
                </div>
                <div id="tmdbLoading" class="tmdb-loading" style="display:none">
                    <span class="spinner"></span> æœç´¢ä¸­...
                </div>
                <div id="tmdbError" class="tmdb-error" style="display:none"></div>
                <div id="tmdbResults" class="tmdb-results"></div>
            </div>
        </div>
    </div>

    <!-- Toast å®¹å™¨ -->
    <div id="toastContainer" class="toast-container"></div>
</body>
</html>
