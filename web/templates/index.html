<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NFO ç¼–è¾‘å™¨</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <div class="file-browser">
            <div class="file-browser-header">
                <h3>ğŸ“ æ–‡ä»¶æµè§ˆ</h3>
                <div class="batch-controls" style="display:none">
                    <button class="btn btn-secondary btn-small" onclick="toggleBatchMode()">âœ“ å¤šé€‰</button>
                </div>
            </div>
            <div class="path-bar" id="currentPath">~</div>
            <div class="search-section">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="æœç´¢ NFO æ–‡ä»¶..." onkeypress="if(event.key==='Enter')search()">
                    <button class="btn btn-primary search-btn" onclick="search()">ğŸ”</button>
                    <button class="btn btn-secondary clear-btn" id="clearSearchBtn" onclick="clearSearch()" style="display:none">âœ•</button>
                </div>
                <div class="search-loading" id="searchLoading" style="display:none">
                    <span class="spinner"></span> æœç´¢ä¸­...
                </div>
            </div>
            <div class="search-results" id="searchResults" style="display:none"></div>
            <div class="file-list" id="fileList"></div>

            <!-- æ‰¹é‡æ“ä½œé¢æ¿ -->
            <div id="batchPanel" class="batch-panel" style="display:none">
                <div class="batch-header">
                    <span class="batch-count">å·²é€‰æ‹© <strong id="selectedCount">0</strong> ä¸ªæ–‡ä»¶</span>
                    <button class="btn-icon-small" onclick="exitBatchMode()">Ã—</button>
                </div>
                <div class="batch-actions">
                    <button class="btn btn-primary" onclick="batchTMDBFetch()" style="flex:1">
                        <span class="btn-icon">ğŸ¬</span> æ‰¹é‡è·å– TMDB
                    </button>
                    <button class="btn btn-secondary" onclick="batchSave()" style="flex:1">
                        <span class="btn-icon">ğŸ’¾</span> æ‰¹é‡ä¿å­˜
                    </button>
                </div>
            </div>

            <!-- ç§»åŠ¨ç«¯æ“ä½œæŒ‰é’® -->
            <div class="mobile-actions" style="display:none">
                <button class="btn btn-secondary" onclick="showTemplateModal()" style="flex:1">ğŸ“‹ æ¨¡æ¿</button>
            </div>

            <div class="template-section">
                <h4>ğŸ“‹ æ¨¡æ¿</h4>
                <div id="templateList"></div>
                <button class="btn btn-secondary" onclick="showTemplateModal()" style="width:100%;margin-top:5px">+ æ–°å»ºæ¨¡æ¿</button>
            </div>
        </div>
        
        <div class="editor">
            <h2>
                NFO ç¼–è¾‘å™¨
                <span id="modifiedBadge" class="modified-badge" style="display:none">â— æœªä¿å­˜</span>
                <button class="btn-icon-small" onclick="toggleHistory()" title="æ“ä½œå†å²" id="historyBtn" style="display:none">ğŸ“œ</button>
            </h2>

            <!-- å†å²é¢æ¿ -->
            <div id="historyPanel" class="history-panel" style="display:none">
                <div class="history-header">
                    <h4>æ“ä½œå†å²</h4>
                    <button class="btn-icon-small" onclick="toggleHistory()">Ã—</button>
                </div>
                <div class="history-tabs">
                    <button class="history-tab active" onclick="showHistoryTab('single', this)">å•ä¸ªæ“ä½œ</button>
                    <button class="history-tab" onclick="showHistoryTab('batch', this)">æ‰¹é‡æ“ä½œ</button>
                </div>
                <div id="historyList" class="history-list"></div>
                <div id="batchHistoryList" class="history-list" style="display:none"></div>
            </div>

            <div id="editorContent">
                <p style="color:#666">â† ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ª .nfo æ–‡ä»¶å¼€å§‹ç¼–è¾‘</p>
            </div>

            <!-- æ·»åŠ åŠ è½½çŠ¶æ€è¦†ç›–å±‚ -->
            <div id="editorLoading" class="editor-loading" style="display:none">
                <div class="loading-spinner">
                    <span class="spinner large"></span>
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentFile = null;
        let nfoData = null;

        // ä¿®æ”¹çŠ¶æ€ç®¡ç†
        let isModified = false;

        function setModified(value) {
            isModified = value;
            const badge = document.getElementById('modifiedBadge');
            if (badge) {
                badge.style.display = value ? 'inline-block' : 'none';
            }
        }

        function checkModified() {
            if (isModified) {
                return confirm('æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ');
            }
            return true;
        }

        // æ“ä½œå†å²è®°å½•
        let actionHistory = [];

        // æ‰¹é‡æ“ä½œå†å²
        let batchHistory = [];

        function addBatchHistory(action, successCount, failCount) {
            const timestamp = new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit'});
            batchHistory.unshift({
                action,
                successCount,
                failCount,
                timestamp
            });

            if (batchHistory.length > 20) {
                batchHistory = batchHistory.slice(0, 20);
            }

            renderBatchHistory();
        }

        function renderBatchHistory() {
            const list = document.getElementById('batchHistoryList');

            if (batchHistory.length === 0) {
                list.innerHTML = '<div style="color:#666;font-size:12px;padding:10px;text-align:center">æš‚æ— æ‰¹é‡æ“ä½œ</div>';
                return;
            }

            list.innerHTML = batchHistory.map(item => `
                <div class="history-item batch">
                    <div>
                        <strong>${item.action}</strong>
                        <span class="batch-result-success">âœ“ ${item.successCount}</span>
                        ${item.failCount > 0 ? `<span class="batch-result-fail">âœ• ${item.failCount}</span>` : ''}
                    </div>
                    <span class="history-time">${item.timestamp}</span>
                </div>
            `).join('');
        }

        function showHistoryTab(tab, element) {
            const tabs = document.querySelectorAll('.history-tab');
            tabs.forEach(t => t.classList.remove('active'));
            element.classList.add('active');

            document.getElementById('historyList').style.display = tab === 'single' ? 'block' : 'none';
            document.getElementById('batchHistoryList').style.display = tab === 'batch' ? 'block' : 'none';
        }

        // æ‰¹é‡æ“ä½œçŠ¶æ€
        let batchMode = false;
        let selectedFiles = new Set();

        function toggleBatchMode() {
            batchMode = !batchMode;
            const controls = document.querySelector('.batch-controls');
            const panel = document.getElementById('batchPanel');
            const container = document.querySelector('.container');

            if (batchMode) {
                controls.querySelector('button').textContent = 'âœ• å–æ¶ˆ';
                panel.style.display = 'block';
                container.classList.add('batch-mode');
                selectedFiles.clear();
                updateSelectedCount();
            } else {
                exitBatchMode();
            }

            // é‡æ–°æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
            const currentPath = document.getElementById('currentPath').textContent;
            loadDir(currentPath === '~' ? '' : currentPath);
        }

        function exitBatchMode() {
            batchMode = false;
            selectedFiles.clear();

            const controls = document.querySelector('.batch-controls');
            const panel = document.getElementById('batchPanel');
            const container = document.querySelector('.container');

            controls.querySelector('button').textContent = 'âœ“ å¤šé€‰';
            panel.style.display = 'none';
            container.classList.remove('batch-mode');

            const currentPath = document.getElementById('currentPath').textContent;
            loadDir(currentPath === '~' ? '' : currentPath);
        }

        function toggleFileSelection(path) {
            if (selectedFiles.has(path)) {
                selectedFiles.delete(path);
            } else {
                selectedFiles.add(path);
            }

            // æ›´æ–°è§†è§‰çŠ¶æ€
            const item = document.querySelector(`.file-item[data-path="${path}"]`);
            if (item) {
                item.classList.toggle('selected', selectedFiles.has(path));
            }

            updateSelectedCount();
        }

        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedFiles.size;
        }

        function addHistory(action, type) {
            const timestamp = new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            actionHistory.unshift({action, type, timestamp});

            // æœ€å¤šä¿ç•™ 20 æ¡
            if (actionHistory.length > 20) {
                actionHistory = actionHistory.slice(0, 20);
            }

            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            const btn = document.getElementById('historyBtn');

            if (actionHistory.length === 0) {
                btn.style.display = 'none';
                return;
            }

            btn.style.display = 'inline-block';

            list.innerHTML = actionHistory.map(item => `
                <div class="history-item ${item.type}">
                    <span>${item.action}</span>
                    <span class="history-time">${item.timestamp}</span>
                </div>
            `).join('');
        }

        function toggleHistory() {
            const panel = document.getElementById('historyPanel');
            panel.style.display = panel.style.display === 'none' ? 'flex' : 'none';
        }

        // Load directory
        async function loadDir(path = '') {
            if (!checkModified()) return;

            try {
                const res = await fetch('/api/list', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({path})
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail);
                
                document.getElementById('currentPath').textContent = data.current;
                renderFileList(data);
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        function renderFileList(data) {
            const list = document.getElementById('fileList');
            let html = '';

            if (data.parent) {
                const escapedParent = data.parent.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                html += `<div class="file-item dir" onclick="loadDir('${escapedParent}')">ğŸ“ ..</div>`;
            }

            for (const item of data.items) {
                if (item.is_dir) {
                    const escapedPath = item.path.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    html += `<div class="file-item dir" onclick="loadDir('${escapedPath}')">ğŸ“ ${esc(item.name)}</div>`;
                } else if (item.is_nfo) {
                    const checkboxId = `select-${item.path.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    const escapedPath = item.path.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    html += `
                        <div class="file-item nfo ${batchMode ? 'selectable' : ''}" data-path="${escapedPath}">
                            ${batchMode ? `<input type="checkbox" id="${checkboxId}" class="file-checkbox" onchange="toggleFileSelection('${escapedPath}')">` : ''}
                            <label for="${checkboxId}" class="file-item-content" onclick="${batchMode ? '' : `loadNfo('${escapedPath}')`}">
                                ğŸ“„ ${esc(item.name)}
                            </label>
                        </div>
                    `;
                }
            }

            list.innerHTML = html;
        }

        // Load NFO file
        async function loadNfo(path) {
            // æ£€æŸ¥æœªä¿å­˜æ›´æ”¹
            if (!checkModified()) return;

            const loading = document.getElementById('editorLoading');

            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                loading.style.display = 'flex';

                const res = await fetch('/api/load', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({path})
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail);

                currentFile = path;
                nfoData = data.data;
                renderEditor();
                setModified(false); // åŠ è½½æ–°æ–‡ä»¶åæ¸…é™¤ä¿®æ”¹æ ‡è®°
                showToast('åŠ è½½æˆåŠŸ', 'success');

                // è®°å½•å†å²
                addHistory(`åŠ è½½: ${path.split('/').pop()}`, 'load');

                // ç§»åŠ¨ç«¯ï¼šåŠ è½½ååˆ‡æ¢åˆ°ç¼–è¾‘é¢æ¿
                if (window.innerWidth <= 768) {
                    setTimeout(() => {
                        const fileBrowser = document.querySelector('.file-browser');
                        const editor = document.querySelector('.editor');
                        const navItems = document.querySelectorAll('.nav-item');

                        fileBrowser.style.display = 'none';
                        editor.style.display = 'block';

                        navItems.forEach(item => item.classList.remove('active'));
                        navItems[1]?.classList.add('active'); // ç¼–è¾‘æŒ‰é’®
                    }, 100);
                }

            } catch (e) {
                showToast(e.message, 'error');
            } finally {
                loading.style.display = 'none';
            }
        }

        function renderEditor() {
            const d = nfoData;
            document.getElementById('editorContent').innerHTML = `
                <div class="form-grid">
                    <div class="form-group">
                        <label>ç±»å‹</label>
                        <select id="nfo_type">
                            <option value="movie" ${d.nfo_type==='movie'?'selected':''}>ç”µå½±</option>
                            <option value="tvshow" ${d.nfo_type==='tvshow'?'selected':''}>å‰§é›†</option>
                            <option value="episodedetails" ${d.nfo_type==='episodedetails'?'selected':''}>å•é›†</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æ ‡é¢˜</label>
                        <div class="input-with-action">
                            <input type="text" id="title" value="${esc(d.title)}">
                            <button class="btn btn-primary btn-icon" onclick="openTMDBSearch()" title="ä» TMDB æœç´¢">ğŸ”</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>åŸæ ‡é¢˜</label>
                        <input type="text" id="originaltitle" value="${esc(d.originaltitle)}">
                    </div>
                    <div class="form-group">
                        <label>å¹´ä»½</label>
                        <input type="text" id="year" value="${esc(d.year)}" placeholder="1900-2100">
                    </div>
                    <div class="form-group">
                        <label>æ—¶é•¿(åˆ†é’Ÿ)</label>
                        <input type="text" id="runtime" value="${esc(d.runtime)}">
                    </div>
                    <div class="form-group">
                        <label>è¯„åˆ†</label>
                        <input type="text" id="rating" value="${esc(d.rating)}" placeholder="0-10">
                    </div>
                    <div class="form-group">
                        <label>åˆ¶ç‰‡å‚</label>
                        <input type="text" id="studio" value="${esc(d.studio)}">
                    </div>
                    <div class="form-group">
                        <label>å­£</label>
                        <input type="text" id="season" value="${esc(d.season)}">
                    </div>
                    <div class="form-group">
                        <label>é›†</label>
                        <input type="text" id="episode" value="${esc(d.episode)}">
                    </div>
                    <div class="form-group">
                        <label>æ’­å‡ºæ—¥æœŸ</label>
                        <input type="text" id="aired" value="${esc(d.aired)}" placeholder="YYYY-MM-DD">
                    </div>
                    <div class="form-group full-width">
                        <label>ç®€ä»‹</label>
                        <textarea id="plot">${esc(d.plot)}</textarea>
                    </div>
                    <div class="form-group">
                        <label>æµ·æŠ¥è·¯å¾„</label>
                        <input type="text" id="poster" value="${esc(d.poster)}" placeholder="poster.jpg">
                    </div>
                    <div class="form-group">
                        <label>èƒŒæ™¯å›¾è·¯å¾„</label>
                        <input type="text" id="fanart" value="${esc(d.fanart)}" placeholder="fanart.jpg">
                    </div>
                    <div class="form-group full-width">
                        <label>ç±»å‹</label>
                        <div class="list-editor" id="genresEditor"></div>
                    </div>
                    <div class="form-group full-width">
                        <label>å¯¼æ¼”</label>
                        <div class="list-editor" id="directorsEditor"></div>
                    </div>
                    <div class="form-group full-width">
                        <label>æ¼”å‘˜</label>
                        <div class="list-editor" id="actorsEditor"></div>
                    </div>
                </div>
                <div class="actions">
                    <button class="btn btn-primary" id="saveBtn" onclick="saveNfo()">
                        <span class="btn-text">ğŸ’¾ ä¿å­˜</span>
                        <span class="btn-loading" style="display:none"><span class="spinner"></span> ä¿å­˜ä¸­...</span>
                        <span class="btn-success" style="display:none">âœ“ å·²ä¿å­˜</span>
                    </button>
                    <button class="btn btn-secondary" onclick="loadNfo(currentFile)">ğŸ”„ é‡æ–°åŠ è½½</button>
                    <button class="btn btn-secondary" onclick="saveAsTemplate()">ğŸ“‹ å­˜ä¸ºæ¨¡æ¿</button>
                </div>
            `;
            renderListEditor('genresEditor', d.genres, 'genres');
            renderListEditor('directorsEditor', d.directors, 'directors');
            renderActorsEditor();

            // ä¸ºæ‰€æœ‰è¾“å…¥æ¡†æ·»åŠ ä¿®æ”¹è¿½è¸ª
            document.querySelectorAll('#editorContent input, #editorContent textarea, #editorContent select').forEach(el => {
                el.addEventListener('input', () => setModified(true));
                el.addEventListener('change', () => setModified(true));
            });
        }

        function esc(s) {
            return (s || '').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function renderListEditor(containerId, items, field) {
            const container = document.getElementById(containerId);
            let html = '<div class="list-items">';
            items.forEach((item, i) => {
                html += `<span class="list-item">${esc(item)} <span class="remove" onclick="removeItem('${field}', ${i})">Ã—</span></span>`;
            });
            html += '</div>';
            html += `<div class="list-input">
                <input type="text" id="${field}Input" placeholder="æ·»åŠ ..." onkeypress="if(event.key==='Enter')addItem('${field}')">
                <button class="btn btn-secondary" onclick="addItem('${field}')">+</button>
            </div>`;
            container.innerHTML = html;
        }

        function addItem(field) {
            const input = document.getElementById(field + 'Input');
            const val = input.value.trim();
            if (val) {
                nfoData[field].push(val);
                input.value = '';
                renderListEditor(field + 'Editor', nfoData[field], field);
            }
        }

        function removeItem(field, index) {
            nfoData[field].splice(index, 1);
            renderListEditor(field + 'Editor', nfoData[field], field);
        }

        function renderActorsEditor() {
            const container = document.getElementById('actorsEditor');
            let html = '<div class="actors-list">';
            nfoData.actors.forEach((actor, i) => {
                html += `<div class="actor-item">
                    <input type="text" value="${esc(actor.name)}" placeholder="å§“å" onchange="updateActor(${i}, 'name', this.value)">
                    <input type="text" value="${esc(actor.role)}" placeholder="è§’è‰²" onchange="updateActor(${i}, 'role', this.value)">
                    <button class="btn btn-secondary" onclick="removeActor(${i})">Ã—</button>
                </div>`;
            });
            html += '</div>';
            html += `<div class="list-input" style="margin-top:10px">
                <input type="text" id="actorNameInput" placeholder="æ¼”å‘˜å§“å" style="flex:1">
                <input type="text" id="actorRoleInput" placeholder="è§’è‰²" style="flex:1">
                <button class="btn btn-secondary" onclick="addActor()">+</button>
            </div>`;
            container.innerHTML = html;
        }

        function addActor() {
            const name = document.getElementById('actorNameInput').value.trim();
            const role = document.getElementById('actorRoleInput').value.trim();
            if (name) {
                nfoData.actors.push({name, role, thumb: '', order: nfoData.actors.length});
                document.getElementById('actorNameInput').value = '';
                document.getElementById('actorRoleInput').value = '';
                renderActorsEditor();
            }
        }

        function updateActor(index, field, value) {
            nfoData.actors[index][field] = value;
        }

        function removeActor(index) {
            nfoData.actors.splice(index, 1);
            renderActorsEditor();
        }

        function collectData() {
            return {
                nfo_type: document.getElementById('nfo_type').value,
                title: document.getElementById('title').value,
                originaltitle: document.getElementById('originaltitle').value,
                year: document.getElementById('year').value,
                plot: document.getElementById('plot').value,
                runtime: document.getElementById('runtime').value,
                genres: nfoData.genres,
                directors: nfoData.directors,
                actors: nfoData.actors,
                studio: document.getElementById('studio').value,
                rating: document.getElementById('rating').value,
                poster: document.getElementById('poster').value,
                fanart: document.getElementById('fanart').value,
                season: document.getElementById('season').value,
                episode: document.getElementById('episode').value,
                aired: document.getElementById('aired').value,
            };
        }

        async function saveNfo() {
            const saveBtn = document.getElementById('saveBtn');

            try {
                // è®¾ç½®åŠ è½½çŠ¶æ€
                saveBtn.classList.add('loading');

                const data = collectData();
                const res = await fetch('/api/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({path: currentFile, data})
                });
                const result = await res.json();

                if (!res.ok) throw new Error(result.detail);

                // è®¾ç½®æˆåŠŸçŠ¶æ€
                saveBtn.classList.remove('loading');
                saveBtn.classList.add('success');
                showToast('ä¿å­˜æˆåŠŸ!', 'success');

                // æ¸…é™¤ä¿®æ”¹æ ‡è®°
                if (typeof setModified === 'function') {
                    setModified(false);
                }

                // è®°å½•å†å²
                addHistory(`ä¿å­˜: ${currentFile.split('/').pop()}`, 'save');

                // 2ç§’åæ¢å¤æŒ‰é’®çŠ¶æ€
                setTimeout(() => {
                    saveBtn.classList.remove('success');
                }, 2000);

            } catch (e) {
                saveBtn.classList.remove('loading');
                showToast(e.message, 'error');
            }
        }

        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toastContainer');

            // åˆ›å»º Toast å…ƒç´ 
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            // æ·»åŠ å›¾æ ‡
            const icons = {
                success: 'âœ“',
                error: 'âœ•',
                warning: 'âš ',
                info: 'â„¹'
            };

            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <span class="toast-message">${esc(message)}</span>
            `;

            container.appendChild(toast);

            // è‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                toast.classList.add('removing');
                toast.addEventListener('animationend', () => {
                    toast.remove();
                });
            }, duration);

            // å…è®¸ç‚¹å‡»å…³é—­
            toast.addEventListener('click', () => {
                toast.classList.add('removing');
                toast.addEventListener('animationend', () => {
                    toast.remove();
                });
            });
        }

        // ç§»åŠ¨ç«¯é¢æ¿ç®¡ç†
        function showMobilePanel(panel) {
            const fileBrowser = document.querySelector('.file-browser');
            const editor = document.querySelector('.editor');
            const navItems = document.querySelectorAll('.nav-item');

            // æ›´æ–°å¯¼èˆªçŠ¶æ€
            navItems.forEach(item => item.classList.remove('active'));
            event.target.closest('.nav-item').classList.add('active');

            // åˆ‡æ¢é¢æ¿
            switch(panel) {
                case 'files':
                    fileBrowser.style.display = 'flex';
                    editor.style.display = 'none';
                    break;
                case 'editor':
                    fileBrowser.style.display = 'none';
                    editor.style.display = 'block';
                    break;
                case 'search':
                    document.getElementById('searchInput').focus();
                    if (window.innerWidth <= 768) {
                        showMobilePanel('files'); // æœç´¢åœ¨æ–‡ä»¶é¢æ¿ä¸­
                    }
                    break;
            }
        }

        // Init
        loadDir('');
        loadTemplates();

        // åˆå§‹åŒ–ï¼šæ˜¾ç¤ºæ‰¹é‡æ§åˆ¶æŒ‰é’®
        document.querySelector('.batch-controls').style.display = 'block';

        // æ‰¹é‡ TMDB è·å–çŠ¶æ€
        let batchTMDBState = {
            active: false,
            total: 0,
            completed: 0,
            failed: 0,
            results: []
        };

        // æ‰¹é‡ TMDB è·å–
        async function batchTMDBFetch() {
            if (selectedFiles.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'warning');
                return;
            }

            // ç¡®è®¤æ“ä½œ
            if (!confirm(`ç¡®å®šè¦æ‰¹é‡è·å– ${selectedFiles.size} ä¸ªæ–‡ä»¶çš„ TMDB æ•°æ®ï¼Ÿ`)) {
                return;
            }

            // åˆå§‹åŒ–çŠ¶æ€
            batchTMDBState = {
                active: true,
                total: selectedFiles.size,
                completed: 0,
                failed: 0,
                results: []
            };

            // æ˜¾ç¤ºè¿›åº¦é¢æ¿
            showBatchProgress();

            // é€ä¸ªå¤„ç†
            const files = Array.from(selectedFiles);
            for (const filePath of files) {
                try {
                    // åŠ è½½æ–‡ä»¶
                    const loadRes = await fetch('/api/load', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({path: filePath})
                    });
                    const loadData = await loadRes.json();

                    if (!loadRes.ok) throw new Error(loadData.detail);

                    const currentTitle = loadData.data.title;
                    if (!currentTitle) {
                        throw new Error('æ²¡æœ‰æ ‡é¢˜');
                    }

                    // æœç´¢ TMDB
                    updateBatchProgress(`æœç´¢: ${currentTitle}`);
                    const searchRes = await fetch(`/api/tmdb/search?q=${encodeURIComponent(currentTitle)}`);
                    const searchData = await searchRes.json();

                    if (!searchRes.ok) {
                        throw new Error(searchData.detail || 'æœç´¢å¤±è´¥');
                    }

                    if (!searchData.results || searchData.results.length === 0) {
                        throw new Error('æœªæ‰¾åˆ°ç»“æœ');
                    }

                    // é€‰æ‹©ç¬¬ä¸€ä¸ªç»“æœ
                    const firstResult = searchData.results[0];
                    const endpoint = firstResult.media_type === 'movie'
                        ? `/api/tmdb/movie/${firstResult.id}`
                        : `/api/tmdb/tv/${firstResult.id}`;

                    // è·å–è¯¦æƒ…
                    updateBatchProgress(`è·å–è¯¦æƒ…: ${currentTitle}`);
                    const detailRes = await fetch(endpoint);
                    const detailData = await detailRes.json();

                    if (!detailRes.ok) {
                        throw new Error(detailData.detail || 'è·å–è¯¦æƒ…å¤±è´¥');
                    }

                    // ä¿å­˜æ–‡ä»¶
                    updateBatchProgress(`ä¿å­˜: ${currentTitle}`);
                    const saveRes = await fetch('/api/save', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            path: filePath,
                            data: detailData
                        })
                    });

                    if (!saveRes.ok) {
                        throw new Error('ä¿å­˜å¤±è´¥');
                    }

                    // è®°å½•æˆåŠŸ
                    batchTMDBState.completed++;
                    batchTMDBState.results.push({
                        file: filePath,
                        success: true,
                        title: currentTitle
                    });

                } catch (e) {
                    // è®°å½•å¤±è´¥
                    batchTMDBState.failed++;
                    batchTMDBState.results.push({
                        file: filePath,
                        success: false,
                        error: e.message
                    });
                }

                updateBatchProgress();
            }

            // å®Œæˆ
            batchTMDBState.active = false;
            showBatchComplete();

            // è®°å½•æ‰¹é‡å†å²
            addBatchHistory('æ‰¹é‡ TMDB è·å–', batchTMDBState.completed, batchTMDBState.failed);

            // é€€å‡ºå¤šé€‰æ¨¡å¼
            exitBatchMode();
        }

        // æ‰¹é‡ä¿å­˜
        async function batchSave() {
            if (selectedFiles.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'warning');
                return;
            }

            // è¾“å…¥è¦æ›´æ–°çš„å­—æ®µ
            const field = prompt('è¦æ‰¹é‡æ›´æ–°å“ªä¸ªå­—æ®µï¼Ÿ\n(ä¾‹: studio, year, rating, director)');

            if (!field) return;

            const value = prompt(`è¾“å…¥ ${field} çš„æ–°å€¼:`);
            if (value === null) return;

            // ç¡®è®¤æ“ä½œ
            if (!confirm(`ç¡®å®šè¦å°† ${selectedFiles.size} ä¸ªæ–‡ä»¶çš„ ${field} æ›´æ–°ä¸º "${value}"ï¼Ÿ`)) {
                return;
            }

            // åˆå§‹åŒ–çŠ¶æ€
            batchTMDBState = {
                active: true,
                total: selectedFiles.size,
                completed: 0,
                failed: 0,
                results: []
            };

            showBatchProgress();

            // é€ä¸ªå¤„ç†
            const files = Array.from(selectedFiles);
            for (const filePath of files) {
                try {
                    // åŠ è½½æ–‡ä»¶
                    updateBatchProgress(`åŠ è½½: ${filePath.split('/').pop()}`);
                    const loadRes = await fetch('/api/load', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({path: filePath})
                    });
                    const loadData = await loadRes.json();

                    if (!loadRes.ok) throw new Error(loadData.detail);

                    // æ›´æ–°å­—æ®µ
                    loadData.data[field] = value;

                    // ä¿å­˜æ–‡ä»¶
                    updateBatchProgress(`ä¿å­˜: ${filePath.split('/').pop()}`);
                    const saveRes = await fetch('/api/save', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            path: filePath,
                            data: loadData.data
                        })
                    });

                    if (!saveRes.ok) throw new Error('ä¿å­˜å¤±è´¥');

                    batchTMDBState.completed++;

                } catch (e) {
                    batchTMDBState.failed++;
                    batchTMDBState.results.push({
                        file: filePath,
                        success: false,
                        error: e.message
                    });
                }

                updateBatchProgress();
            }

            batchTMDBState.active = false;
            showBatchComplete();

            // è®°å½•æ‰¹é‡å†å²
            addBatchHistory(`æ‰¹é‡æ›´æ–° ${field}`, batchTMDBState.completed, batchTMDBState.failed);

            exitBatchMode();
        }

        // æ˜¾ç¤ºæ‰¹é‡è¿›åº¦
        function showBatchProgress() {
            document.getElementById('batchProgressModal').classList.add('active');
            updateBatchProgress();
        }

        // æ›´æ–°æ‰¹é‡è¿›åº¦
        function updateBatchProgress(message) {
            const total = batchTMDBState.total;
            const completed = batchTMDBState.completed;
            const failed = batchTMDBState.failed;
            const processed = completed + failed;
            const percent = (processed / total) * 100;

            // æ›´æ–°ç»Ÿè®¡
            document.getElementById('progressTotal').textContent = total;
            document.getElementById('progressCompleted').textContent = completed;
            document.getElementById('progressFailed').textContent = failed;

            // æ›´æ–°è¿›åº¦æ¡
            document.getElementById('progressFill').style.width = percent + '%';

            // æ›´æ–°å½“å‰æ–‡ä»¶æ¶ˆæ¯
            if (message) {
                document.getElementById('currentFile').textContent = message;
            }
        }

        // æ˜¾ç¤ºæ‰¹é‡å®Œæˆ
        function showBatchComplete() {
            const {total, completed, failed} = batchTMDBState;

            // æ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
            setTimeout(() => {
                document.getElementById('batchProgressModal').classList.remove('active');

                if (failed === 0) {
                    showToast(`å…¨éƒ¨å®Œæˆï¼æˆåŠŸ ${completed} ä¸ªæ–‡ä»¶`, 'success');
                } else {
                    // æœ‰å¤±è´¥æ—¶æç¤ºæŸ¥çœ‹é”™è¯¯è¯¦æƒ…
                    if (confirm(`å®Œæˆ ${completed} ä¸ªï¼Œå¤±è´¥ ${failed} ä¸ª\n\nç‚¹å‡»"ç¡®å®š"æŸ¥çœ‹é”™è¯¯è¯¦æƒ…`)) {
                        showBatchErrors();
                    }
                }
            }, 1000);
        }

        // æ˜¾ç¤ºæ‰¹é‡é”™è¯¯è¯¦æƒ…
        function showBatchErrors() {
            const failedResults = batchTMDBState.results.filter(r => !r.success);

            if (failedResults.length === 0) {
                showToast('æ²¡æœ‰å¤±è´¥çš„æ–‡ä»¶', 'info');
                return;
            }

            const list = document.getElementById('batchErrorList');
            list.innerHTML = failedResults.map(item => `
                <div class="batch-error-item">
                    <div class="batch-error-file">ğŸ“„ ${esc(item.file.split('/').pop())}</div>
                    <div class="batch-error-reason">${esc(item.error)}</div>
                </div>
            `).join('');

            document.getElementById('batchErrorModal').classList.add('active');
        }

        // å…³é—­æ‰¹é‡é”™è¯¯è¯¦æƒ…
        function closeBatchErrorModal() {
            document.getElementById('batchErrorModal').classList.remove('active');
        }

        // å¤„ç†è™šæ‹Ÿé”®ç›˜å¼¹å‡º
        let originalHeight = window.innerHeight;

        window.addEventListener('resize', () => {
            const currentHeight = window.innerHeight;
            const keyboardHeight = originalHeight - currentHeight;

            // å¦‚æœé”®ç›˜å¼¹å‡ºï¼ˆé«˜åº¦å‡å°‘è¶…è¿‡ 150pxï¼‰
            if (keyboardHeight > 150) {
                document.body.classList.add('keyboard-open');

                // æ»šåŠ¨åˆ°èšç„¦å…ƒç´ 
                const activeElement = document.activeElement;
                if (activeElement) {
                    activeElement.scrollIntoView({behavior: 'smooth', block: 'center'});
                }
            } else {
                document.body.classList.remove('keyboard-open');
            }
        });

        // ä¿å­˜åŸå§‹é«˜åº¦
        window.addEventListener('load', () => {
            originalHeight = window.innerHeight;
        });

        // ç§»åŠ¨ç«¯æ»‘åŠ¨æ‰‹åŠ¿
        let touchStartX = 0;
        let touchStartY = 0;

        document.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        }, {passive: true});

        document.addEventListener('touchend', (e) => {
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;

            const diffX = touchEndX - touchStartX;
            const diffY = touchEndY - touchStartY;

            // æ°´å¹³æ»‘åŠ¨è¶…è¿‡ 100px ä¸”å‚ç›´æ»‘åŠ¨å°äº 50px
            if (Math.abs(diffX) > 100 && Math.abs(diffY) < 50) {
                if (diffX > 0) {
                    // å³æ»‘ï¼šè¿”å›æ–‡ä»¶é¢æ¿
                    const editor = document.querySelector('.editor');
                    if (editor.style.display !== 'none' && window.innerWidth <= 768) {
                        const fileBrowser = document.querySelector('.file-browser');
                        const navItems = document.querySelectorAll('.nav-item');

                        fileBrowser.style.display = 'flex';
                        editor.style.display = 'none';

                        navItems.forEach(item => item.classList.remove('active'));
                        navItems[0]?.classList.add('active'); // æ–‡ä»¶æŒ‰é’®
                    }
                }
            }
        }, {passive: true});

        // ä¸‹æ‹‰åˆ·æ–°
        let pullStartY = 0;
        let isPulling = false;
        const pullThreshold = 80;

        document.querySelector('.file-browser').addEventListener('touchstart', (e) => {
            const fileList = document.getElementById('fileList');
            if (fileList.scrollTop === 0) {
                pullStartY = e.touches[0].clientY;
                isPulling = true;
            }
        }, {passive: true});

        document.querySelector('.file-browser').addEventListener('touchmove', (e) => {
            if (!isPulling) return;

            const currentY = e.touches[0].clientY;
            const diff = currentY - pullStartY;

            if (diff > 0 && diff < pullThreshold * 2) {
                e.preventDefault();
                // å¯ä»¥æ·»åŠ è§†è§‰åé¦ˆ
            }
        }, {passive: false});

        document.querySelector('.file-browser').addEventListener('touchend', (e) => {
            if (!isPulling) return;

            const endY = e.changedTouches[0].clientY;
            const diff = endY - pullStartY;

            if (diff > pullThreshold) {
                // åˆ·æ–°å½“å‰ç›®å½•
                const currentPath = document.getElementById('currentPath').textContent;
                loadDir(currentPath === '~' ? '' : currentPath);
                showToast('å·²åˆ·æ–°', 'info');
            }

            isPulling = false;
        }, {passive: true});

        // é”®ç›˜äº‹ä»¶
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeTMDBModal();
            }
        });

        // ========== TMDB æœç´¢åŠŸèƒ½ ==========
        let searchDebounceTimer = null;
        const SEARCH_DEBOUNCE_MS = 300;

        // æ‰“å¼€ TMDB æœç´¢æ¨¡æ€æ¡†ï¼Œé¢„å¡«å½“å‰æ ‡é¢˜å¹¶è‡ªåŠ¨æœç´¢
        function openTMDBSearch() {
            const modal = document.getElementById('tmdbModal');
            const searchInput = document.getElementById('tmdbSearchInput');

            // é¢„å¡«å½“å‰æ ‡é¢˜ä½œä¸ºæœç´¢è¯
            const currentTitle = document.getElementById('title')?.value || '';
            searchInput.value = currentTitle;

            // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
            document.getElementById('tmdbResults').innerHTML = '';
            document.getElementById('tmdbError').style.display = 'none';

            modal.classList.add('active');

            // å¦‚æœæœ‰é¢„å¡«å†…å®¹ï¼Œè‡ªåŠ¨æœç´¢
            if (currentTitle) {
                // å…ˆè®¾ç½®åŠ è½½çŠ¶æ€ï¼Œé¿å…ç©ºç™½é—ªçƒ
                document.getElementById('tmdbLoading').style.display = 'flex';
                searchTMDB();
            } else {
                searchInput.focus();
            }
        }

        // å…³é—­ TMDB æœç´¢æ¨¡æ€æ¡†
        function closeTMDBModal() {
            document.getElementById('tmdbModal').classList.remove('active');
        }

        // å¤„ç†æ¨¡æ€æ¡†ç‚¹å‡»äº‹ä»¶ï¼ˆèƒŒæ™¯ç‚¹å‡»å…³é—­ï¼‰
        function handleModalClick(event) {
            if (event.target.id === 'tmdbModal') {
                closeTMDBModal();
            }
        }

        // æ¨¡æ€æ¡†æ»‘åŠ¨å…³é—­
        let touchStartY = 0;
        let modalContent = null;

        function handleTouchStart(e) {
            touchStartY = e.touches[0].clientY;
        }

        function handleTouchMove(e) {
            if (!modalContent) return;

            const touchY = e.touches[0].clientY;
            const diff = touchY - touchStartY;

            if (diff > 0) {
                modalContent.style.transform = `translateY(${diff}px)`;
            }
        }

        function handleTouchEnd(e) {
            if (!modalContent) return;

            const touchY = e.changedTouches[0].clientY;
            const diff = touchY - touchStartY;

            if (diff > 100) {
                closeTMDBModal();
            }

            modalContent.style.transform = '';
        }

        // åœ¨æ‰“å¼€æ¨¡æ€æ¡†æ—¶æ·»åŠ è§¦æ‘¸ç›‘å¬
        const originalOpenTMDBSearch = openTMDBSearch;
        openTMDBSearch = function() {
            originalOpenTMDBSearch();
            modalContent = document.querySelector('.modal-content');

            if (modalContent) {
                modalContent.addEventListener('touchstart', handleTouchStart);
                modalContent.addEventListener('touchmove', handleTouchMove);
                modalContent.addEventListener('touchend', handleTouchEnd);
            }
        };

        // åœ¨å…³é—­æ¨¡æ€æ¡†æ—¶ç§»é™¤ç›‘å¬
        const originalCloseTMDBModal = closeTMDBModal;
        closeTMDBModal = function() {
            originalCloseTMDBModal();

            if (modalContent) {
                modalContent.removeEventListener('touchstart', handleTouchStart);
                modalContent.removeEventListener('touchmove', handleTouchMove);
                modalContent.removeEventListener('touchend', handleTouchEnd);
                modalContent = null;
            }
        };

        // æ‰§è¡Œ TMDB æœç´¢è¯·æ±‚
        async function searchTMDB() {
            // æ¸…é™¤ä¹‹å‰çš„é˜²æŠ–è®¡æ—¶å™¨
            if (searchDebounceTimer) {
                clearTimeout(searchDebounceTimer);
            }

            const query = document.getElementById('tmdbSearchInput').value.trim();

            if (!query) {
                showToast('è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'error');
                return;
            }

            // éªŒè¯æŸ¥è¯¢é•¿åº¦
            if (query.length > 200) {
                showToast('æœç´¢å…³é”®è¯è¿‡é•¿ï¼ˆæœ€å¤š200å­—ç¬¦ï¼‰', 'error');
                return;
            }

            const loading = document.getElementById('tmdbLoading');
            const errorDiv = document.getElementById('tmdbError');
            const resultsDiv = document.getElementById('tmdbResults');

            // UI çŠ¶æ€
            loading.style.display = 'flex';
            errorDiv.style.display = 'none';
            resultsDiv.innerHTML = '';

            // é˜²æŠ–ï¼š300ms åæ‰§è¡Œæœç´¢
            searchDebounceTimer = setTimeout(async () => {
                try {
                    const res = await fetch(`/api/tmdb/search?q=${encodeURIComponent(query)}`);
                    const data = await res.json();

                    if (!res.ok) {
                        // æ˜ å°„é”™è¯¯æ¶ˆæ¯
                        let errorMsg = 'æœç´¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                        if (res.status === 401) {
                            errorMsg = 'TMDB API Key æœªé…ç½®æˆ–æ— æ•ˆï¼Œè¯·è”ç³»ç®¡ç†å‘˜';
                        } else if (res.status === 429) {
                            errorMsg = 'æœç´¢è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•';
                        } else if (data.detail) {
                            errorMsg = data.detail;
                        }
                        throw new Error(errorMsg);
                    }

                    renderTMDBResults(data.results);
                } catch (e) {
                    errorDiv.textContent = e.message;
                    errorDiv.style.display = 'block';
                } finally {
                    loading.style.display = 'none';
                }
            }, SEARCH_DEBOUNCE_MS);
        }

        // æ¸²æŸ“ TMDB æœç´¢ç»“æœå¡ç‰‡
        function renderTMDBResults(results) {
            const container = document.getElementById('tmdbResults');

            if (results.length === 0) {
                container.innerHTML = '<div class="tmdb-no-results">æœªæ‰¾åˆ°åŒ¹é…ç»“æœ</div>';
                return;
            }

            // è¿‡æ»¤åªæ˜¾ç¤ºç”µå½±å’Œç”µè§†å‰§
            const filteredResults = results.filter(item =>
                item.media_type === 'movie' || item.media_type === 'tv'
            );

            if (filteredResults.length === 0) {
                container.innerHTML = '<div class="tmdb-no-results">æœªæ‰¾åˆ°åŒ¹é…çš„ç”µå½±æˆ–å‰§é›†</div>';
                return;
            }

            let html = '<div class="tmdb-results-grid">';
            for (const item of filteredResults) {
                const posterUrl = item.poster_url
                    ? item.poster_url
                    : 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="300" viewBox="0 0 200 300"><rect fill="%232a2a4a" width="200" height="300"/><text fill="%23666" x="50%" y="50%" text-anchor="middle" dy=".3em" font-size="24">ğŸ¬</text></svg>';
                const year = item.year || 'æœªçŸ¥';
                const typeLabel = item.media_type === 'movie' ? 'ç”µå½±' : 'å‰§é›†';

                html += `
                    <div class="tmdb-result-card" onclick="selectTMDBResult(${item.id}, '${item.media_type}')">
                        <div class="tmdb-poster">
                            <img src="${posterUrl}" alt="${esc(item.title)}" loading="lazy">
                        </div>
                        <div class="tmdb-info">
                            <span class="tmdb-type">${typeLabel}</span>
                            <div class="tmdb-title">${esc(item.title)}</div>
                            <div class="tmdb-year">${year}</div>
                        </div>
                    </div>
                `;
            }
            html += '</div>';
            container.innerHTML = html;
        }

        // é€‰æ‹© TMDB ç»“æœå¹¶è·å–è¯¦æƒ…
        async function selectTMDBResult(tmdbId, mediaType) {
            const loading = document.getElementById('tmdbLoading');
            const errorDiv = document.getElementById('tmdbError');

            loading.style.display = 'flex';
            errorDiv.style.display = 'none';

            try {
                let endpoint;
                if (mediaType === 'movie') {
                    endpoint = `/api/tmdb/movie/${tmdbId}`;
                } else {
                    endpoint = `/api/tmdb/tv/${tmdbId}`;
                }

                const res = await fetch(endpoint);
                const nfoDataResult = await res.json();

                if (!res.ok) {
                    // æ˜ å°„é”™è¯¯æ¶ˆæ¯
                    let errorMsg = 'è·å–è¯¦æƒ…å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                    if (res.status === 401) {
                        errorMsg = 'TMDB API Key æœªé…ç½®æˆ–æ— æ•ˆï¼Œè¯·è”ç³»ç®¡ç†å‘˜';
                    } else if (res.status === 404) {
                        errorMsg = 'æœªæ‰¾åˆ°è¯¥å†…å®¹çš„è¯¦ç»†ä¿¡æ¯';
                    } else if (res.status === 429) {
                        errorMsg = 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•';
                    } else if (nfoDataResult.detail) {
                        errorMsg = nfoDataResult.detail;
                    }
                    throw new Error(errorMsg);
                }

                // å¡«å……è¡¨å•
                applyTMDBData(nfoDataResult);

                // å…³é—­æ¨¡æ€æ¡†ï¼ˆä»…åœ¨æˆåŠŸæ—¶ï¼‰
                closeTMDBModal();
                showToast('å·²ä» TMDB è·å–æ•°æ®', 'success');
            } catch (e) {
                errorDiv.textContent = e.message;
                errorDiv.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        // å°† TMDB æ•°æ®åº”ç”¨åˆ° NFO è¡¨å•
        function applyTMDBData(data) {
            if (!nfoData) {
                showToast('è¯·å…ˆåŠ è½½æˆ–åˆ›å»º NFO æ–‡ä»¶', 'error');
                return;
            }

            // æ›´æ–° nfoData å¯¹è±¡
            nfoData.nfo_type = data.nfo_type || nfoData.nfo_type;
            nfoData.title = data.title || '';
            nfoData.originaltitle = data.originaltitle || '';
            nfoData.year = data.year || '';
            nfoData.plot = data.plot || '';
            nfoData.runtime = data.runtime || '';
            nfoData.rating = data.rating || '';
            nfoData.genres = data.genres || [];
            nfoData.directors = data.directors || [];
            nfoData.actors = data.actors || [];
            nfoData.studio = data.studio || '';
            nfoData.poster = data.poster || '';
            nfoData.fanart = data.fanart || '';
            nfoData.season = data.season || '';
            nfoData.episode = data.episode || '';
            nfoData.aired = data.aired || '';

            // é‡æ–°æ¸²æŸ“è¡¨å•
            renderEditor();

            // è®°å½•å†å²
            addHistory('ä» TMDB è·å–æ•°æ®', 'apply');
        }

        // ========== æœç´¢åŠŸèƒ½ ==========
        let searchResults = [];
        let selectedSearchResult = null;

        async function search() {
            const query = document.getElementById('searchInput').value.trim();
            
            // å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼Œæ¸…é™¤æœç´¢ç»“æœ
            if (!query) {
                clearSearch();
                return;
            }
            
            const currentPath = document.getElementById('currentPath').textContent;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('searchLoading').style.display = 'flex';
            document.getElementById('clearSearchBtn').style.display = 'none';
            
            try {
                const res = await fetch('/api/search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        query: query,
                        path: currentPath === '~' ? '' : currentPath,
                        max_depth: 5,
                        max_results: 50
                    })
                });
                const data = await res.json();
                
                if (!res.ok) {
                    throw new Error(data.detail || 'æœç´¢å¤±è´¥');
                }
                
                searchResults = data.results;
                renderSearchResults(data.results, data.truncated);
                
            } catch (e) {
                showToast(e.message, 'error');
            } finally {
                document.getElementById('searchLoading').style.display = 'none';
            }
        }

        function renderSearchResults(results, truncated) {
            const container = document.getElementById('searchResults');
            const fileList = document.getElementById('fileList');
            
            // æ˜¾ç¤ºæœç´¢ç»“æœåŒºåŸŸï¼Œéšè—æ–‡ä»¶åˆ—è¡¨
            container.style.display = 'block';
            fileList.style.display = 'none';
            document.getElementById('clearSearchBtn').style.display = 'inline-block';
            
            if (results.length === 0) {
                container.innerHTML = '<div class="search-no-results">æœªæ‰¾åˆ°åŒ¹é…çš„æ–‡ä»¶</div>';
                return;
            }
            
            let html = `
                <div class="search-results-header">
                    <span>æœç´¢ç»“æœ</span>
                    <span class="search-results-count">${results.length} ä¸ªæ–‡ä»¶</span>
                </div>
            `;
            
            if (truncated) {
                html += '<div class="search-truncated">âš ï¸ ç»“æœå¯èƒ½ä¸å®Œæ•´ï¼Œå·²è¾¾åˆ°æœ€å¤§æ•°é‡é™åˆ¶</div>';
            }
            
            for (const item of results) {
                const isSelected = selectedSearchResult === item.path ? 'selected' : '';
                const matchTypeLabel = getMatchTypeLabel(item.match_type);
                
                html += `
                    <div class="search-result-item ${isSelected}" onclick="selectSearchResult('${esc(item.path)}')">
                        <div class="search-result-filename">ğŸ“„ ${esc(item.filename)}</div>
                        <div class="search-result-path">${esc(item.path)}</div>
                        <span class="search-result-match">${matchTypeLabel}</span>
                        ${item.title ? `<div class="search-result-title">${esc(item.title)}</div>` : ''}
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function getMatchTypeLabel(matchType) {
            const labels = {
                'filename': 'æ–‡ä»¶å',
                'title': 'æ ‡é¢˜',
                'originaltitle': 'åŸæ ‡é¢˜',
                'actor': 'æ¼”å‘˜',
                'plot': 'ç®€ä»‹'
            };
            return labels[matchType] || matchType;
        }

        async function selectSearchResult(path) {
            selectedSearchResult = path;
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            const items = document.querySelectorAll('.search-result-item');
            items.forEach(item => {
                if (item.onclick.toString().includes(path)) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
            
            // åŠ è½½ NFO æ–‡ä»¶
            await loadNfo(path);
            
            // å¯¼èˆªåˆ°æ–‡ä»¶æ‰€åœ¨ç›®å½•
            const parentDir = path.substring(0, path.lastIndexOf('/')) || path.substring(0, path.lastIndexOf('\\'));
            if (parentDir) {
                document.getElementById('currentPath').textContent = parentDir;
            }
        }

        function clearSearch() {
            const container = document.getElementById('searchResults');
            const fileList = document.getElementById('fileList');
            
            // éšè—æœç´¢ç»“æœï¼Œæ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
            container.style.display = 'none';
            fileList.style.display = 'block';
            document.getElementById('clearSearchBtn').style.display = 'none';
            document.getElementById('searchInput').value = '';
            
            searchResults = [];
            selectedSearchResult = null;
            
            // é‡æ–°åŠ è½½å½“å‰ç›®å½•
            const currentPath = document.getElementById('currentPath').textContent;
            loadDir(currentPath === '~' ? '' : currentPath);
        }

        // ========== æ¨¡æ¿åŠŸèƒ½ ==========
        let templates = [];

        async function loadTemplates() {
            try {
                const res = await fetch('/api/templates');
                const data = await res.json();
                templates = data.templates || [];
                renderTemplates();
            } catch (e) {
                console.error('åŠ è½½æ¨¡æ¿å¤±è´¥', e);
            }
        }

        function renderTemplates() {
            const list = document.getElementById('templateList');
            if (templates.length === 0) {
                list.innerHTML = '<div style="color:#666;font-size:12px;padding:5px">æš‚æ— æ¨¡æ¿</div>';
                return;
            }
            list.innerHTML = templates.map(t => `
                <div class="template-item">
                    <span onclick="applyTemplate('${esc(t.name)}')">${esc(t.name)}</span>
                    <span class="remove" onclick="deleteTemplate('${esc(t.name)}')">Ã—</span>
                </div>
            `).join('');
        }

        function applyTemplate(name) {
            const t = templates.find(x => x.name === name);
            if (!t || !nfoData) return;
            
            nfoData.nfo_type = t.nfo_type || nfoData.nfo_type;
            nfoData.genres = [...(t.genres || [])];
            nfoData.directors = [...(t.directors || [])];
            nfoData.studio = t.studio || nfoData.studio;
            
            renderEditor();
            showToast('å·²åº”ç”¨æ¨¡æ¿: ' + name, 'success');
        }

        async function deleteTemplate(name) {
            if (!confirm('ç¡®å®šåˆ é™¤æ¨¡æ¿ "' + name + '"?')) return;
            try {
                const res = await fetch('/api/templates/' + encodeURIComponent(name), {method: 'DELETE'});
                if (!res.ok) throw new Error('åˆ é™¤å¤±è´¥');
                await loadTemplates();
                showToast('æ¨¡æ¿å·²åˆ é™¤', 'success');
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        async function saveAsTemplate() {
            const name = prompt('è¯·è¾“å…¥æ¨¡æ¿åç§°:');
            if (!name) return;
            
            const data = {
                name,
                nfo_type: document.getElementById('nfo_type').value,
                genres: nfoData.genres,
                directors: nfoData.directors,
                studio: document.getElementById('studio').value,
            };
            
            try {
                const res = await fetch('/api/templates', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                if (!res.ok) throw new Error('ä¿å­˜å¤±è´¥');
                await loadTemplates();
                showToast('æ¨¡æ¿å·²ä¿å­˜', 'success');
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        function showTemplateModal() {
            if (!nfoData) {
                showToast('è¯·å…ˆæ‰“å¼€ä¸€ä¸ª NFO æ–‡ä»¶', 'error');
                return;
            }
            saveAsTemplate();
        }
    </script>

    <!-- TMDB æœç´¢æ¨¡æ€æ¡† -->
    <div id="tmdbModal" class="modal" onclick="handleModalClick(event)">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ¬ æœç´¢ TMDB</h3>
                <button class="modal-close" onclick="closeTMDBModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="tmdb-search-bar">
                    <input type="text" id="tmdbSearchInput" placeholder="è¾“å…¥ç”µå½±æˆ–å‰§é›†åç§°..."
                        onkeypress="if(event.key==='Enter')searchTMDB()">
                    <button class="btn btn-primary" onclick="searchTMDB()">æœç´¢</button>
                </div>
                <div id="tmdbLoading" class="tmdb-loading" style="display:none">
                    <span class="spinner"></span> æœç´¢ä¸­...
                </div>
                <div id="tmdbError" class="tmdb-error" style="display:none"></div>
                <div id="tmdbResults" class="tmdb-results"></div>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡æ“ä½œè¿›åº¦æ¨¡æ€æ¡† -->
    <div id="batchProgressModal" class="modal">
        <div class="modal-content batch-progress-content">
            <div class="modal-header">
                <h3>ğŸ“¦ æ‰¹é‡æ“ä½œè¿›åº¦</h3>
            </div>
            <div class="modal-body">
                <div class="batch-progress-summary">
                    <div class="progress-stat">
                        <span class="stat-value" id="progressTotal">0</span>
                        <span class="stat-label">æ€»æ•°</span>
                    </div>
                    <div class="progress-stat">
                        <span class="stat-value success" id="progressCompleted">0</span>
                        <span class="stat-label">å®Œæˆ</span>
                    </div>
                    <div class="progress-stat">
                        <span class="stat-value error" id="progressFailed">0</span>
                        <span class="stat-label">å¤±è´¥</span>
                    </div>
                </div>
                <div class="batch-progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="batch-current-file" id="currentFile"></div>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡æ“ä½œé”™è¯¯è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="batchErrorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>âŒ æ‰¹é‡æ“ä½œé”™è¯¯è¯¦æƒ…</h3>
                <button class="modal-close" onclick="closeBatchErrorModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div id="batchErrorList" class="batch-error-list"></div>
            </div>
        </div>
    </div>

    <!-- ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆª -->
    <nav class="mobile-nav" style="display:none">
        <button class="nav-item active" onclick="showMobilePanel('files')">
            <span class="nav-icon">ğŸ“</span>
            <span class="nav-label">æ–‡ä»¶</span>
        </button>
        <button class="nav-item" onclick="showMobilePanel('editor')">
            <span class="nav-icon">âœï¸</span>
            <span class="nav-label">ç¼–è¾‘</span>
        </button>
        <button class="nav-item" onclick="showMobilePanel('search')">
            <span class="nav-icon">ğŸ”</span>
            <span class="nav-label">æœç´¢</span>
        </button>
    </nav>

    <!-- Toast å®¹å™¨ -->
    <div id="toastContainer" class="toast-container"></div>
</body>
</html>
