<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>编辑 NFO - {{ file_name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .main-content {
            max-width: 1000px;
        }

        .form-group label {
            cursor: default;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .tags-input {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px;
            border: 1px solid #3a3a5a;
            border-radius: 6px;
            background: #0f0f1a;
            min-height: 44px;
        }

        .tag {
            background: #2a2a4a;
            color: #e8e8f0;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tag-remove {
            cursor: pointer;
            color: #8a8aaa;
            transition: color 0.2s;
        }

        .tag-remove:hover {
            color: #ff6b6b;
        }

        .tags-input input {
            flex: 1;
            min-width: 100px;
            border: none;
            background: transparent;
            color: #e8e8f0;
            font-size: 14px;
            padding: 4px;
        }

        .tags-input input:focus {
            outline: none;
        }

        .actors-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .actor-item {
            display: flex;
            gap: 12px;
            align-items: center;
            padding: 12px;
            background: #0f0f1a;
            border: 1px solid #2a2a4a;
            border-radius: 6px;
        }

        .actor-item input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #3a3a5a;
            border-radius: 4px;
            background: #1a1a2e;
            color: #e8e8f0;
            font-size: 13px;
        }

        .actor-item input:focus {
            outline: none;
            border-color: #00d4ff;
        }

        .actor-remove {
            padding: 6px 10px;
            background: #2a2a4a;
            border: 1px solid #4a4a6a;
            border-radius: 4px;
            color: #ff6b6b;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .actor-remove:hover {
            background: #3a3a3a;
            border-color: #ff6b6b;
        }

        .btn-add {
            padding: 8px 16px;
            background: #2a2a4a;
            border: 1px dashed #4a4a6a;
            border-radius: 6px;
            color: #8a8aaa;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .btn-add:hover {
            border-color: #00d4ff;
            color: #00d4ff;
        }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: #1a1a2e;
            border: 1px solid #2a2a4a;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        .toast.success {
            border-color: #10b981;
        }

        .toast.error {
            border-color: #ff6b6b;
        }

        .hidden {
            display: none;
        }

        /* Episode List Styles */
        .episode-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
            padding: 12px;
            background: #0f0f1a;
            border: 1px solid #2a2a4a;
            border-radius: 6px;
        }

        .episode-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: #1a1a2e;
            border: 1px solid #2a2a4a;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .episode-checkbox-item:hover {
            background: #2a2a4a;
            border-color: #3a3a5a;
        }

        .episode-checkbox-item input[type="checkbox"] {
            cursor: pointer;
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .episode-checkbox-item input[type="checkbox"]:checked + span {
            color: #00d4ff;
        }

        .episode-number {
            font-weight: 500;
            color: #00d4ff;
            flex-shrink: 0;
        }

        .episode-title {
            flex: 1;
            font-size: 13px;
            color: #e8e8f0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>编辑 NFO</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="goBack()">返回列表</button>
            <button class="btn btn-success" onclick="saveAndDownload()">保存并下载</button>
        </div>
    </div>

    <div class="main-content">
        <!-- NFO Type Selection -->
        <div class="form-section">
            <h2>NFO 类型</h2>
            <div class="form-group">
                <label for="nfoType">选择输出类型</label>
                <select id="nfoType" onchange="toggleNfoTypeFields()">
                    <option value="movie">电影 (movie.nfo)</option>
                    <option value="tvshow">剧集 (tvshow.nfo)</option>
                    <option value="episode">单集 (episode.nfo)</option>
                </select>
            </div>
        </div>

        <!-- Basic Info Section -->
        <div class="form-section">
            <h2>基本信息</h2>
            <div class="form-grid">
                <div class="form-group form-full">
                    <label for="title">标题 *</label>
                    <input type="text" id="title" required>
                </div>
                <div class="form-group">
                    <label for="originaltitle">原始标题</label>
                    <input type="text" id="originaltitle">
                </div>
                <div class="form-group">
                    <label for="year">年份</label>
                    <input type="number" id="year" min="1900" max="2100">
                </div>
                <div class="form-group form-full">
                    <label for="plot">剧情简介</label>
                    <textarea id="plot" rows="4"></textarea>
                </div>
            </div>
        </div>

        <!-- Details Section -->
        <div class="form-section">
            <h2>详细信息</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label for="runtime">时长（分钟）</label>
                    <input type="number" id="runtime" min="0">
                </div>
                <div class="form-group">
                    <label for="rating">评分</label>
                    <input type="number" id="rating" min="0" max="10" step="0.1">
                </div>
                <div class="form-group">
                    <label for="studio">制片厂</label>
                    <input type="text" id="studio">
                </div>
                <div class="form-group">
                    <label for="poster">海报 URL</label>
                    <input type="url" id="poster">
                </div>
                <div class="form-group">
                    <label for="fanart">背景图 URL</label>
                    <input type="url" id="fanart">
                </div>
            </div>
        </div>

        <!-- TV Show Fields -->
        <div class="form-section hidden" id="tvShowFields">
            <h2>剧集信息</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label for="season">季</label>
                    <input type="number" id="season" min="0">
                </div>
                <div class="form-group">
                    <label for="episode">集</label>
                    <input type="number" id="episode" min="0">
                </div>
                <div class="form-group form-full">
                    <label for="aired">首播日期</label>
                    <input type="text" id="aired" placeholder="YYYY-MM-DD">
                </div>
            </div>
        </div>

        <!-- Genres Section -->
        <div class="form-section">
            <h2>类型</h2>
            <div class="form-group">
                <div class="tags-input" id="genresContainer">
                    <input type="text" id="genresInput" placeholder="输入类型后按回车添加...">
                </div>
            </div>
        </div>

        <!-- Directors Section -->
        <div class="form-section">
            <h2>导演</h2>
            <div class="form-group">
                <div class="tags-input" id="directorsContainer">
                    <input type="text" id="directorsInput" placeholder="输入导演后按回车添加...">
                </div>
            </div>
        </div>

        <!-- Actors Section -->
        <div class="form-section">
            <h2>演员</h2>
            <div class="actors-list" id="actorsList">
                <!-- Actors will be rendered here -->
            </div>
            <button class="btn-add" onclick="addActor()">+ 添加演员</button>
        </div>
    </div>

    <script>
        const fileId = '{{ file_id }}';
        let originalData = null;
        let genres = [];
        let directors = [];
        let actors = [];

        // Load file data on page load
        async function loadFileData() {
            try {
                const response = await fetch(`/api/files/${fileId}`);
                const result = await response.json();

                if (response.ok) {
                    originalData = result.data;
                    populateForm(originalData);
                } else {
                    showToast(result.error || '加载文件失败', 'error');
                }
            } catch (error) {
                showToast('加载文件失败: ' + error.message, 'error');
            }
        }

        function populateForm(data) {
            // Set NFO type
            const nfoType = data.nfo_type || 'movie';
            document.getElementById('nfoType').value = nfoType;
            toggleNfoTypeFields();

            // Basic fields
            document.getElementById('title').value = data.title || '';
            document.getElementById('originaltitle').value = data.originaltitle || '';
            document.getElementById('year').value = data.year || '';
            document.getElementById('plot').value = data.plot || '';
            document.getElementById('runtime').value = data.runtime || '';
            document.getElementById('rating').value = data.rating || '';
            document.getElementById('studio').value = data.studio || '';
            document.getElementById('poster').value = data.poster || '';
            document.getElementById('fanart').value = data.fanart || '';

            // TV Show fields
            if (data.nfo_type === 'tvshow' || data.nfo_type === 'episode') {
                document.getElementById('tvShowFields').classList.remove('hidden');
                document.getElementById('season').value = data.season || '';
                document.getElementById('episode').value = data.episode || '';
                document.getElementById('aired').value = data.aired || '';
            }

            // Genres
            genres = data.genres || [];
            renderGenres();

            // Directors
            directors = data.directors || [];
            renderDirectors();

            // Actors
            actors = data.actors || [];
            renderActors();
        }

        function renderGenres() {
            const container = document.getElementById('genresContainer');
            const input = document.getElementById('genresInput');

            // Remove existing tags
            container.querySelectorAll('.tag').forEach(t => t.remove());

            // Add tags before input
            genres.forEach((genre, index) => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `
                    ${genre}
                    <span class="tag-remove" onclick="removeGenre(${index})">×</span>
                `;
                container.insertBefore(tag, input);
            });
        }

        function addGenre(value) {
            if (value && !genres.includes(value)) {
                genres.push(value);
                renderGenres();
            }
        }

        function removeGenre(index) {
            genres.splice(index, 1);
            renderGenres();
        }

        function renderDirectors() {
            const container = document.getElementById('directorsContainer');
            const input = document.getElementById('directorsInput');

            container.querySelectorAll('.tag').forEach(t => t.remove());

            directors.forEach((director, index) => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `
                    ${director}
                    <span class="tag-remove" onclick="removeDirector(${index})">×</span>
                `;
                container.insertBefore(tag, input);
            });
        }

        function addDirector(value) {
            if (value && !directors.includes(value)) {
                directors.push(value);
                renderDirectors();
            }
        }

        function removeDirector(index) {
            directors.splice(index, 1);
            renderDirectors();
        }

        function renderActors() {
            const container = document.getElementById('actorsList');
            container.innerHTML = actors.map((actor, index) => `
                <div class="actor-item">
                    <input type="text" placeholder="姓名" value="${actor.name || ''}" data-index="${index}" data-field="name" onchange="updateActor(${index}, 'name', this.value)">
                    <input type="text" placeholder="角色" value="${actor.role || ''}" data-index="${index}" data-field="role" onchange="updateActor(${index}, 'role', this.value)">
                    <input type="text" placeholder="头像 URL" value="${actor.thumb || ''}" data-index="${index}" data-field="thumb" onchange="updateActor(${index}, 'thumb', this.value)">
                    <button class="actor-remove" onclick="removeActor(${index})">删除</button>
                </div>
            `).join('');
        }

        function addActor() {
            actors.push({ name: '', role: '', thumb: '', order: actors.length });
            renderActors();
        }

        function removeActor(index) {
            actors.splice(index, 1);
            renderActors();
        }

        function updateActor(index, field, value) {
            actors[index][field] = value;
        }

        // Handle Enter key for tags input
        document.getElementById('genresInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addGenre(e.target.value.trim());
                e.target.value = '';
            }
        });

        document.getElementById('directorsInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addDirector(e.target.value.trim());
                e.target.value = '';
            }
        });

        // Save data
        async function saveData() {
            const nfoType = document.getElementById('nfoType').value;
            const data = {
                nfo_type: nfoType,
                title: document.getElementById('title').value,
                originaltitle: document.getElementById('originaltitle').value,
                year: document.getElementById('year').value ? parseInt(document.getElementById('year').value) : null,
                plot: document.getElementById('plot').value,
                runtime: document.getElementById('runtime').value ? parseInt(document.getElementById('runtime').value) : null,
                rating: document.getElementById('rating').value ? parseFloat(document.getElementById('rating').value) : null,
                studio: document.getElementById('studio').value,
                poster: document.getElementById('poster').value,
                fanart: document.getElementById('fanart').value,
                season: document.getElementById('season').value ? parseInt(document.getElementById('season').value) : null,
                episode: document.getElementById('episode').value ? parseInt(document.getElementById('episode').value) : null,
                aired: document.getElementById('aired').value,
                genres: genres,
                directors: directors,
                actors: actors
            };

            try {
                const response = await fetch(`/api/files/${fileId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    showToast('保存成功', 'success');
                    return true;
                } else {
                    showToast(result.error || '保存失败', 'error');
                    return false;
                }
            } catch (error) {
                showToast('保存失败: ' + error.message, 'error');
                return false;
            }
        }

        async function saveAndDownload() {
            const saved = await saveData();
            if (saved) {
                window.location.href = `/api/files/${fileId}/download`;
            }
        }

        function goBack() {
            window.location.href = '/';
        }

        function toggleNfoTypeFields() {
            const nfoType = document.getElementById('nfoType').value;
            const tvShowFields = document.getElementById('tvShowFields');

            if (nfoType === 'tvshow' || nfoType === 'episode') {
                tvShowFields.classList.remove('hidden');
            } else {
                tvShowFields.classList.add('hidden');
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Load data on page load
        loadFileData();
    </script>
</body>
</html>
