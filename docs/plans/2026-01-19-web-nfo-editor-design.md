# Web NFO 编辑器设计文档

> **日期**: 2026-01-19
> **类型**: 功能设计
> **状态**: 设计完成

---

## 1. 需求概述

构建一个基于 Web 的 NFO 编辑器，支持用户上传 NFO 文件、在线编辑并下载。采用容器化部署，简单密码保护访问。

| 方面 | 选择 |
|------|------|
| 部署方式 | Docker 容器化 |
| 访问控制 | 全局单密码 |
| 文件存储 | 会话模式（临时存储，编辑后下载） |
| 编辑界面 | Web 表单 |
| 批量处理 | 支持批量上传，选择后批量设置字段 |
| 下载方式 | 单独下载 + ZIP 打包 |

---

## 2. 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                          用户浏览器                                │
│  ┌───────────┐  ┌──────────────┐  ┌─────────────────────────┐    │
│  │  登录页面  │  │   文件管理    │  │      编辑界面            │    │
│  │           │  │  ┌────────┐  │  │  ┌─────┐  ┌───────────┐  │    │
│  │           │  │  │ 单文件  │  │  │  │单文件│  │ 批量编辑  │  │    │
│  │           │  │  │ 批量    │  │  │  │表单  │  │ 设置面板  │  │    │
│  │           │  │  └────────┘  │  │  └─────┘  └───────────┘  │    │
│  └───────────┘  └──────────────┘  └─────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Flask Web 应用 (Docker)                       │
│  ┌───────────┐  ┌──────────────┐  ┌─────────────────────────┐    │
│  │ 会话管理   │  │  密码验证     │  │      文件处理层          │    │
│  │           │  │              │  │  ┌────────────────────┐  │    │
│  │ - 临时存储│  │ - 单一密码   │  │  │ - 单文件解析/生成   │  │    │
│  │ - 过期清理│  │ - 环境变量   │  │  │ - 批量解析         │  │    │
│  └───────────┘  └──────────────┘  │  │ - 批量字段更新     │  │    │
│                                  │  │ - ZIP 打包         │  │    │
│                                  │  └────────────────────┘  │    │
│                                  └─────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│              NFO 解析与生成 (复用现有代码)                         │
│        NfoModel + TMDB 服务（可选集成）                           │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 核心功能模块

### 3.1 认证模块
- 单一密码验证（环境变量配置）
- Session 管理（登录状态保持）

### 3.2 文件管理模块

| 功能 | 描述 |
|------|------|
| 上传 | 支持拖拽、多选、批量上传 |
| 解析 | 解析 NFO 并展示字段列表 |
| 存储 | 会话临时存储，定时清理过期文件 |
| 下载 | 单文件下载 / ZIP 打包下载 |

### 3.3 编辑模块

| 模式 | 功能 |
|------|------|
| 单文件编辑 | 完整表单编辑所有字段 |
| 批量编辑 | 勾选多个文件 → 选择字段 → 统一设置值 |

---

## 4. 用户流程设计

### 4.1 登录流程
```
访问网站 → 输入密码 → Session 验证 → 进入文件管理页面
```

### 4.2 单文件编辑流程
```
上传 NFO → 解析显示表单 → 编辑字段 → 预览 → 下载 NFO
```

### 4.3 批量处理流程
```
批量上传 → 文件列表（勾选框）
    ↓
勾选要修改的文件 → 选择目标字段 → 输入新值
    ↓
批量应用 → 预览变更 → 单独下载 或 ZIP 打包下载
```

---

## 5. 数据结构设计

### 5.1 会话存储结构
```python
session = {
    'authenticated': True,
    'files': {
        'file_id_1': {
            'name': 'movie.nfo',
            'original_data': {...},    # 解析后的原始数据
            'edited_data': {...},      # 编辑后的数据
            'modified_fields': ['title', 'plot'],  # 跟踪修改的字段
            'upload_time': timestamp
        },
        # ... 更多文件
    }
}
```

### 5.2 批量操作请求结构
```python
batch_update_request = {
    'file_ids': ['file_id_1', 'file_id_2', ...],
    'field': 'director',           # 要修改的字段
    'value': 'Christopher Nolan',  # 新值
    'operation': 'set'             # set / append / replace
}
```

---

## 6. 技术实现

### 6.1 后端技术栈
```
Flask              # Web 框架
Flask-Session      # 会话管理（服务端 Session）
werkzeug           # 密码哈希验证
lxml / existing    # NFO 解析（复用现有代码）
```

### 6.2 目录结构
```
nfo-xg/
├── web/                    # 新增 Web 应用
│   ├── app.py             # Flask 应用主入口
│   ├── routes/            # 路由模块
│   │   ├── __init__.py
│   │   ├── auth.py        # 登录/登出
│   │   ├── file.py        # 文件上传/下载/解析
│   │   └── batch.py       # 批量操作
│   ├── templates/         # Jinja2 模板
│   │   ├── login.html
│   │   ├── files.html     # 文件列表
│   │   ├── edit.html      # 单文件编辑
│   │   └── batch.html     # 批量编辑
│   └── static/            # CSS/JS
├── Dockerfile             # Docker 镜像构建
├── docker-compose.yml     # 容器编排
└── nfo_editor/            # 现有 NFO 解析代码（复用）
```

### 6.3 环境变量配置
```bash
# .env
NFO_PASSWORD=your_password_here      # 登录密码
SECRET_KEY=random_secret_key         # Session 加密密钥
SESSION_TIMEOUT=3600                 # 会话超时（秒）
MAX_UPLOAD_SIZE=10485760             # 最大上传（10MB）
```

---

## 7. 前端页面设计

### 7.1 登录页
```
┌─────────────────────────────┐
│          NFO Editor          │
│                             │
│   ┌─────────────────────┐   │
│   │   请输入访问密码      │   │
│   │   [•••••••••••••]    │   │
│   │                     │   │
│   │    [  登  录  ]      │   │
│   └─────────────────────┘   │
└─────────────────────────────┘
```

### 7.2 文件管理页
```
┌─────────────────────────────────────────────────────────────┐
│ NFO Editor                    [+] 上传文件     [登出]        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─── 文件列表 ──────────────────────────────────────────┐  │
│  │                                                        │  │
│  │  ┌────────────────────────────────────────────────┐   │  │
│  │  │ ☐ movie.nfo          [编辑] [删除]             │   │  │
│  │  │    已修改: title, director                      │   │  │
│  │  ├────────────────────────────────────────────────┤   │  │
│  │  │ ☑ tvshow.nfo        [编辑] [删除]             │   │  │
│  │  │    已修改: plot, year                          │   │  │
│  │  └────────────────────────────────────────────────┘   │  │
│  │                                                        │  │
│  └────────────────────────────────────────────────────┘  │
│                                                             │
│  已选择 2 个文件  [批量编辑]  [下载 ZIP]                     │
└─────────────────────────────────────────────────────────────┘
```

### 7.3 单文件编辑页
```
┌─────────────────────────────────────────────────────────────┐
│ ← 返回    编辑: movie.nfo                      [保存] [下载] │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  标题        [The Dark Knight                                ] │
│  年份        [2008                                           ] │
│  导演        [Christopher Nolan                              ] │
│  编剧        [Jonathan Nolan, Christopher Nolan             ] │
│  演员        [Christian Bale, Heath Ledger, Aaron Eckhart   ] │
│  类型        [Action, Crime, Drama                           ] │
│  简介        [When Batman...                                 ] │
│              [                                              ] │
│              [                     ▼ 预览/编辑切换          ] │
└─────────────────────────────────────────────────────────────┘
```

### 7.4 批量编辑面板
```
┌─────────────────────────────────────────────────────────────┐
│ 批量编辑 (2 个文件)                           [应用] [取消]   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  要修改的字段    [年份 ▼]                                    │
│                                                             │
│  操作类型        ○ 设置新值  ○ 追加  ○ 查找替换            │
│                                                             │
│  新值            [2024                                       ] │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 预览变更:                                            │   │
│  │ • movie.nfo:    year 2008 → 2024                    │   │
│  │ • tvshow.nfo:   year 2005 → 2024                    │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## 8. API 接口设计

### 8.1 认证相关

| 方法 | 路径 | 功能 |
|------|------|------|
| POST | `/api/login` | 密码验证 |
| POST | `/api/logout` | 退出登录 |
| GET | `/api/auth/check` | 检查登录状态 |

### 8.2 文件操作

| 方法 | 路径 | 功能 |
|------|------|------|
| POST | `/api/files/upload` | 上传并解析 NFO |
| GET | `/api/files` | 获取文件列表 |
| GET | `/api/files/<id>` | 获取单个文件数据 |
| PUT | `/api/files/<id>` | 更新文件字段 |
| DELETE | `/api/files/<id>` | 删除文件 |
| GET | `/api/files/<id>/download` | 下载单个 NFO |

### 8.3 批量操作

| 方法 | 路径 | 功能 |
|------|------|------|
| POST | `/api/batch/update` | 批量更新字段 |
| GET | `/api/batch/download` | ZIP 打包下载 |
| DELETE | `/api/batch/delete` | 批量删除 |

---

## 9. Docker 部署

### 9.1 Dockerfile
```dockerfile
FROM python:3.13-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

EXPOSE 5000
CMD ["gunicorn", "--bind", "0.0.0.0:5000", "web.app:app"]
```

### 9.2 docker-compose.yml
```yaml
services:
  nfo-editor:
    build: .
    ports:
      - "5000:5000"
    environment:
      - NFO_PASSWORD=${NFO_PASSWORD}
      - SECRET_KEY=${SECRET_KEY}
    volumes:
      - ./uploads:/tmp/nfo_uploads
    restart: unless-stopped
```

---

## 10. 后续步骤

1. ✅ 设计文档完成
2. ⏳ 创建实现计划
3. ⏳ 设置开发工作区
4. ⏳ 实现后端 API
5. ⏳ 实现前端页面
6. ⏳ 测试与部署
